<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YDC Procurement Inventory</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{ --brand:#0d6efd; }
    body{ background:#f6f7fb; color:#212529; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }
    .navbar{ background:#ffffff; border-bottom:1px solid rgba(0,0,0,.08) }
    .card{ background:#ffffff; border:1px solid rgba(0,0,0,.08); border-radius:18px }
    .btn-rounded{ border-radius:999px }
    .badge-soft{ background:#f1f5f9; border:1px solid rgba(0,0,0,.06) }
    .pill{ border-radius:999px; padding:.35rem .7rem }
    .table thead th{ position:sticky; top:0; background:#fff; z-index:1 }
    .search-input{ border-radius:12px }
    .modal-content{ background:#ffffff; border:1px solid rgba(0,0,0,.06); border-radius:18px }
    .form-control,.form-select{ background:#fff; border:1px solid #dee2e6 }
    .form-control:focus,.form-select:focus{ border-color:var(--brand); box-shadow:0 0 0 .25rem rgba(13,110,253,.15) }
    .btn-light-alt{ background:#fff; border:1px solid rgba(0,0,0,.12); color:#212529 }
    .btn-light-alt:hover{ background:#f2f4f7 }
    .border-dash{ border:1px dashed rgba(0,0,0,.2) }
    /* --- High-contrast, detailed toasts (bottom-right) --- */
    .toast{
      --t-bg:#111827; --t-fg:#f8fafc; --t-border:#334155; --t-accent:#94a3b8;
      background:var(--t-bg)!important;
      color:var(--t-fg)!important;
      border:1px solid var(--t-border)!important;
      border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
      overflow:hidden;
      transform-origin: bottom right;
    }
    .toast.toast-pop{ animation: toastPop .25s ease-out; }
    @keyframes toastPop{ from{transform:scale(.96); opacity:0} to{transform:none; opacity:1} }

    .toast .toast-body{
      display:grid;
      grid-template-columns:22px 1fr auto;
      gap:.75rem;
      align-items:start;
      padding:.75rem 1rem;
    }
    .toast .toast-icon{ opacity:.95; margin-top:.2rem; }
    .toast .title{ font-weight:700; letter-spacing:.2px; }
    .toast .msg{ margin-top:.15rem; line-height:1.35; }
    .toast .meta{ margin-top:.35rem; font-size:.78rem; opacity:.85; }
    .toast .toast-close{
      margin-left:.5rem;
      border:0; background:transparent; color:inherit; opacity:.7;
    }
    .toast .toast-close:hover{ opacity:1; }

    /* progress bar at the bottom of each toast */
    .toast .toast-progress{
      height:3px;
      grid-column:1 / -1;
      background:var(--t-accent);
      opacity:.8;
      transform-origin:left;
      animation: toastProgress linear forwards;
    }
    @keyframes toastProgress{ from{transform:scaleX(1)} to{transform:scaleX(0)} }

    /* per-type themes */
    .toast-success{ --t-bg:#0b2d19; --t-border:#1f7a3a; --t-fg:#e7fff2; --t-accent:#2ecc71; }
    .toast-info   { --t-bg:#0b2239; --t-border:#0d6efd; --t-fg:#eaf2ff; --t-accent:#60a5fa; }
    .toast-warning{ --t-bg:#332701; --t-border:#b38700; --t-fg:#fff7db; --t-accent:#fbbf24; }
    .toast-danger { --t-bg:#3a0a0a; --t-border:#a61b29; --t-fg:#ffe7ea; --t-accent:#f87171; }

    /* Select Items modal: clickable rows + picked highlight */
    #tblCatalog tbody tr.row-pickable { cursor: pointer; }
    #tblCatalog tbody tr.row-picked   { background: rgba(13,110,253,.06); }
    #tblCatalog tbody tr .form-control,
    #tblCatalog tbody tr .form-check-input { cursor: auto; }

    /* --- Button loading helper --- */
    .btn-loading{ pointer-events:none; opacity:.85 }
    .btn-loading .spinner-border{ margin-right:.5rem }
    /* Make the Heads-up modal stack above other modals */
    #modalRetiredHeadsUp{ z-index: 1065; }
    .modal-backdrop.hup-top{ z-index: 1060 !important; }
    /* Compact filter bars */
    .filter-bar{
      display:flex; align-items:center; gap:.5rem;
      flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch;
    }
    .filter-bar > *{ flex:0 0 auto; }
    .filter-bar .form-control,.filter-bar .form-select{ height: calc(1.5em + .5rem + 2px); }
    .table td .badge{ font-weight:600; }

    /* ===== SKU History modal ===== */
    #modalSkuHistory .modal-dialog { max-width: 1100px; }
    #modalSkuHistory .history-wrap   { max-height: 65vh; overflow:auto; }
    #modalSkuHistory .sku-history-table th,
    #modalSkuHistory .sku-history-table td { vertical-align: middle; }
    #modalSkuHistory .sku-history-table td.when   { min-width:170px; white-space:nowrap; }
    #modalSkuHistory .sku-history-table td.type   { min-width:120px; white-space:nowrap; }
    #modalSkuHistory .sku-history-table td.delta  { min-width:90px;  text-align:right; white-space:nowrap; }
    #modalSkuHistory .sku-history-table td.uom    { min-width:80px;  white-space:nowrap; }
    #modalSkuHistory .sku-history-table td.status { min-width:110px; white-space:nowrap; }
    #modalSkuHistory .sku-history-table td.by     { min-width:160px; white-space:nowrap; }
    #modalSkuHistory .sku-history-table td.id     { min-width:140px; white-space:nowrap; color:#6c757d; }
    #modalSkuHistory .sku-history-table td.note { min-width:320px; white-space:pre-wrap; }
    #modalSkuHistory .sku-history-table thead th { position: sticky; top: 0; background:#fff; z-index: 1; }

    /* ===== Micro-animations ===== */
    .anim-reveal { opacity: 0; transform: translateY(10px); transition: opacity .45s ease, transform .45s ease; }
    .anim-reveal.show { opacity: 1; transform: none; }
    .anim-row { opacity: 0; transform: translateY(6px); }
    .anim-row.show { opacity: 1; transform: none; transition: opacity .25s ease, transform .25s ease; }
    .kpi-pop { animation: kpiPop .45s cubic-bezier(.2,.7,.2,1); }
    @keyframes kpiPop { 0%{transform:scale(.98)} 50%{transform:scale(1.02)} 100%{transform:none} }
    .btn { transition: transform .06s ease; position: relative; overflow: hidden; }
    .btn:active { transform: translateY(1px); }
    .ripple {
      position: absolute; border-radius: 50%; pointer-events: none; transform: scale(0);
      opacity: .3; background: currentColor; animation: ripple .6s ease-out forwards;
    }
    @keyframes ripple { to { transform: scale(3); opacity: 0; } }
    .modal.fade .modal-dialog { transform: translateY(12px); transition: transform .2s ease-out; }
    .modal.show .modal-dialog { transform: none; }
    .toast { transform-origin: bottom right; }
    .toast.toast-pop { animation: toastPop .25s ease-out; }
    @keyframes toastPop { from{transform:scale(.96); opacity:0} to{transform:none; opacity:1} }

    /* ===== App Loader (splash) ===== */
    #appLoader{
      position:fixed; inset:0; z-index:2000;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(246,247,251,.98), rgba(246,247,251,.92));
      backdrop-filter:saturate(1.2) blur(2px);
      transition:opacity .28s ease, visibility .28s ease;
    }
    #appLoader.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
    #appLoader .loader-card{
      background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:18px;
      padding:18px 20px; width:min(520px,92vw);
      box-shadow:0 12px 28px rgba(0,0,0,.12);
    }
    #appLoader .loader-title{ font-weight:700; }
    #appLoader .loader-bar{
      position:relative; height:4px; border-radius:999px; background:#e9ecef; overflow:hidden;
    }
    #appLoader .loader-bar::after{
      content:""; position:absolute; inset:0; width:42%; height:100%;
      border-radius:999px; background:var(--brand, #0d6efd);
      transform:translateX(-100%); animation:indeterminate 1.15s ease-in-out infinite;
    }
    @keyframes indeterminate{
      0%{transform:translateX(-100%)} 50%{transform:translateX(40%)} 100%{transform:translateX(240%)}
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold" href="#"><i class="fa-solid fa-boxes-stacked me-2"></i>YDC Procurement Inventory</a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="dbChip" class="badge pill bg-secondary-subtle text-dark d-none" title="Connected Spreadsheet"></span>
        <span id="whoami" class="badge pill bg-secondary-subtle text-dark d-none"></span>
        <span id="syncChip" class="badge pill bg-secondary-subtle text-dark d-none" title="Last synced at"></span>

        <!-- Tools (controller only) -->
        <div class="dropdown d-none" id="toolsMenu">
          <button class="btn btn-sm btn-light-alt dropdown-toggle" data-bs-toggle="dropdown"><i class="fa-solid fa-wrench me-1"></i>Tools</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="actConnect"><i class="fa-solid fa-link me-2"></i>Connect DB (spreadsheet ID)</a></li>
            <li><a class="dropdown-item" href="#" id="actSeed"><i class="fa-solid fa-seedling me-2"></i>Seed Test Data</a></li>
            <li><a class="dropdown-item" href="#" id="actReload"><i class="fa-solid fa-rotate me-2"></i>Reload</a></li>
          </ul>
        </div>

        <a id="switchLink" class="btn btn-sm btn-light-alt d-none" href="https://accounts.google.com/Logout" target="_blank" rel="noopener">Switch account</a>
      </div>
    </div>
  </nav>

  <!-- App Loader Overlay (shown only on first boot) -->
  <div id="appLoader" aria-live="polite">
    <div class="loader-card">
      <div class="d-flex align-items-center gap-2 mb-1">
        <i class="fa-solid fa-boxes-stacked"></i>
        <span class="loader-title">YDC Procurement Inventory</span>
      </div>
      <div id="loaderMsg" class="small text-secondary">Loading…</div>
      <div class="loader-bar mt-3"></div>
      <div id="loaderTip" class="small text-muted mt-2">Tip: Click an item name to view details.</div>
    </div>
  </div>

  <!-- LOGIN -->
  <section class="container py-5" id="loginScreen" style="display:none">
    <div class="row justify-content-center">
      <div class="col-lg-6">
        <div class="card p-4 p-md-5">
          <h5 class="mb-2">Sign in</h5>
          <p class="text-secondary mb-3">
            You are signed in as: <strong id="loginEmail">—</strong><br/>
            Access is controlled by the <em>Controller</em>.
          </p>

          <div id="loginStates">
            <div id="stateNoSession" class="alert alert-warning d-none">No Google session detected. Deploy as Web app with access <strong>Anyone in your organization</strong>, then reload.</div>
            <div id="stateUnknown" class="alert alert-info d-none">Your email isn’t registered yet. Create an account below.</div>
            <div id="statePending" class="alert alert-warning d-none">Your account is <strong>Pending</strong>.</div>
            <div id="stateDisabled" class="alert alert-danger d-none">Your account is <strong>Disabled</strong>.</div>
          </div>

          <hr class="my-4"/>
          <div id="createAccountWrap" class="d-none">
            <h6>Create Account</h6>
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label">Name</label><input id="caName" class="form-control" placeholder="Your full name"></div>
              <div class="col-md-6"><label class="form-label">Department</label><input id="caDept" class="form-control" placeholder="Department"></div>
              <div class="col-md-12">
                <label class="form-label">Requested Role</label>
                <select id="caRole" class="form-select">
                  <option value="user">User (Requester)</option>
                  <option value="manager">Inventory Manager</option>
                  <option value="controller">Controller (request)</option>
                </select>
                <div class="form-text">A controller will review and set your role on approval.</div>
              </div>
              <div class="col-12 d-grid d-md-flex gap-2 mt-2">
                <button id="btnCreateAccount" class="btn btn-primary btn-rounded"><i class="fa-solid fa-user-plus me-2"></i>Request access</button>
              </div>
            </div>
          </div>

          <div class="alert alert-info mt-4">
            Controllers can review requests in <strong>Approvals → User Accounts</strong>.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN APP -->
  <section class="container py-4" id="appScreen" style="display:none">
    <div class="row g-3">
      <!-- KPIs -->
      <div class="col-12">
        <div class="row g-3">
          <div class="col-6 col-xl-3">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 id="kpiTitle1" class="mb-0">Active SKUs</h6>
                <i class="fa-solid fa-barcode fs-5 text-secondary"></i>
              </div>
              <div id="kpiSkus" class="display-6 fw-bold">0</div>
            </div>
          </div>
          <div class="col-6 col-xl-3">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 id="kpiTitle2" class="mb-0">Total On-hand</h6>
                <i class="fa-solid fa-box-open fs-5 text-secondary"></i>
              </div>
              <div id="kpiOnhand" class="display-6 fw-bold">0</div>
            </div>
          </div>
          <div class="col-6 col-xl-3">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 id="kpiTitle3" class="mb-0">Pending Approvals</h6>
                <i class="fa-solid fa-clipboard-list fs-5 text-secondary"></i>
              </div>
              <div id="kpiPending" class="display-6 fw-bold">0</div>
            </div>
          </div>
          <div class="col-6 col-xl-3">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 id="kpiTitle4" class="mb-0">Ledger Records</h6>
                <i class="fa-solid fa-book fs-5 text-secondary"></i>
              </div>
              <div id="kpiLedger" class="display-6 fw-bold">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex flex-wrap justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
              <span class="pill badge-soft"><i class="fa-solid fa-bolt"></i></span>
              <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <!-- USER-ONLY -->
              <button id="btnOpenRequest" class="btn btn-primary btn-rounded d-none"
                      data-bs-toggle="modal" data-bs-target="#modalRequest">
                <i class="fa-solid fa-cart-shopping me-2"></i>Request Item
              </button>

              <!-- CONTROLLER/MANAGER -->
              <button id="btnOpenCreate" class="btn btn-success btn-rounded" data-bs-toggle="modal" data-bs-target="#modalCreateSku">
                <i class="fa-solid fa-plus me-2"></i>Create SKU
              </button>
              <button id="btnOpenReceive" class="btn btn-primary btn-rounded" data-bs-toggle="modal" data-bs-target="#modalReceive">
                <i class="fa-solid fa-inbox me-2"></i>Item Inbound / Receiving
              </button>
              <button id="btnOpenIssue" class="btn btn-warning btn-rounded" data-bs-toggle="modal" data-bs-target="#modalIssue">
                <i class="fa-solid fa-truck-arrow-right me-2"></i>Item Outbound / Issuing
              </button>
              <!-- <button id="btnOpenModify" class="btn btn-light-alt btn-rounded" data-bs-toggle="modal" data-bs-target="#modalModifySku">
                <i class="fa-solid fa-pen-to-square me-2"></i>Modify Item
              </button> -->
              <!-- <button id="btnOpenRetire" class="btn btn-outline-danger btn-rounded" data-bs-toggle="modal" data-bs-target="#modalRetireSku">
                <i class="fa-solid fa-box-archive me-2"></i>Retire SKU
              </button> -->
            </div>
          </div>
        </div>
      </div>

      <!-- Stock -->
      <div class="col-12" id="stockWrap">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Stock Overview</h6>
            <div class="filter-bar">
              <input id="stockSearch" class="form-control form-control-sm search-input" placeholder="Search SKU / name / description / category" style="width:240px">
              <select id="stockFilterStatus" class="form-select form-select-sm" style="width:120px">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="On Hold">On Hold</option>
                <option value="Retired">Retired</option>
              </select>
              <select id="stockFilterCat" class="form-select form-select-sm" style="width:160px">
                <option value="">All Categories</option>
              </select>
              <select id="stockFilterUom" class="form-select form-select-sm" style="width:110px">
                <option value="">All UoM</option>
              </select>
              <button id="stockFilterClear" class="btn btn-light-alt btn-sm">Clear</button>
              <button id="btnDlStock" class="btn btn-light-alt btn-sm"><i class="fa-solid fa-download me-1"></i>Download CSV</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle table-hover" id="tblStock">
              <thead><tr>
                <th>SKU</th><th>Item Name</th><th>Description</th><th>UoM</th><th class="text-end">Unit Price</th><th class="text-end">On-hand</th><th>Category</th><th>Status</th><th class="text-end">Actions</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pagerStock" class="d-flex justify-content-between align-items-center mt-2 small"></div>
        </div>
      </div>

      <!-- Pending Requests (User) -->
      <div class="col-12" id="myRequestsWrap" style="display:none">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Pending Requests</h6>
            <div class="filter-bar">
              <input id="mineSearch" class="form-control form-control-sm search-input" placeholder="Search my requests" style="width:240px">
              <select id="mineFilterStatus" class="form-select form-select-sm" style="width:140px">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Declined">Declined</option>
                <option value="Voided">Voided</option>
              </select>
              <button id="mineFilterClear" class="btn btn-light-alt btn-sm">Clear</button>
              <button id="btnDlMine" class="btn btn-light-alt btn-sm"><i class="fa-solid fa-download me-1"></i>Download CSV</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle table-hover" id="tblMine">
              <thead><tr>
                <th>When</th><th>Status</th><th>SKU</th><th>Item</th>
                <th class="text-end">Qty</th><th>UoM</th>
                <th class="text-muted">Record ID</th>
                <th style="width:160px" class="text-end">Current Approver</th>
                <th class="text-end">Actions</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pagerMine" class="d-flex justify-content-between align-items-center mt-2 small"></div>
        </div>
      </div>

      <!-- Approvers modal -->
      <div class="modal fade" id="modalApprovers" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fa-solid fa-users-gear me-2"></i>Approvers</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="approversBody" class="small">No approver data.</div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-light-alt" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>


      <!-- Approvals (Controller) -->
      <div class="col-12" id="approvalsWrap" style="display:none">
        <div class="card p-3">
          <!-- Tabs -->
          <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabTrx" type="button" role="tab"><i class="fa-solid fa-clipboard-list me-1"></i>Transactions</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabUsers" type="button" role="tab"><i class="fa-solid fa-users-gear me-1"></i>User Accounts</button>
            </li>
          </ul>

          <div class="tab-content">
            <!-- Transactions -->
            <div class="tab-pane fade show active" id="tabTrx" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Pending Transactions</h6>
                <div class="filter-bar">
                  <input id="pendingSearch" class="form-control form-control-sm search-input" placeholder="Search pending by SKU, type, user" style="width:240px">
                  <select id="pendFilterType" class="form-select form-select-sm" style="width:150px">
                    <option value="">All Types</option>
                  </select>
                  <select id="pendFilterBy" class="form-select form-select-sm" style="width:180px">
                    <option value="">All Requesters</option>
                  </select>
                  <select id="pendFilterApprover" class="form-select form-select-sm" style="width:160px">
                    <option value="">All Approvers</option>
                    <option value="manager">Managers</option>
                    <option value="controller">Controllers</option>
                  </select>
                  <button id="pendFilterClear" class="btn btn-light-alt btn-sm">Clear</button>
                  <button id="btnDlPending" class="btn btn-light-alt btn-sm"><i class="fa-solid fa-download me-1"></i>Download CSV</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table align-middle" id="tblPending">
                  <thead><tr><th>When</th><th>Type</th><th>SKU</th><th>Details</th><th>Requested by</th><th style="width:160px">Current Approver</th><th class="text-end">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <div id="pagerPending" class="d-flex justify-content-between align-items-center mt-2 small"></div>
            </div>

            <!-- User Accounts -->
            <div class="tab-pane fade" id="tabUsers" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Pending Users</h6>
                <div class="text-secondary small">Approve/disable and set role.</div>
              </div>
              <div class="table-responsive">
                <table class="table align-middle" id="tblUsersPending">
                  <thead>
                    <tr>
                      <th>When</th><th>Name</th><th>Email</th><th>Department</th><th>Requested</th><th>Set Role</th><th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Ledger -->
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Ledger / Transaction Logs</h6>
            <div class="filter-bar">
              <input id="ledgerSearch" class="form-control form-control-sm search-input" placeholder="Search ID, SKU, type, user" style="width:220px">
              <select id="ledgerFilterType" class="form-select form-select-sm" style="width:150px">
                <option value="">All Types</option>
              </select>
              <select id="ledgerFilterStatus" class="form-select form-select-sm" style="width:130px">
                <option value="">All Status</option>
                <option value="Approved">Approved</option>
                <option value="Pending">Pending</option>
                <option value="Declined">Declined</option>
                <option value="Voided">Voided</option>
              </select>
              <div class="input-group input-group-sm" style="width: 290px;">
                <input id="ledgerFrom" type="date" class="form-control">
                <span class="input-group-text">to</span>
                <input id="ledgerTo" type="date" class="form-control">
              </div>
              <button id="ledgerFilterClear" class="btn btn-light-alt btn-sm">Clear</button>
              <button id="btnDlLedger" class="btn btn-light-alt btn-sm"><i class="fa-solid fa-download me-1"></i>Download CSV</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="tblLedger">
              <thead><tr>
                <th>ID</th><th>When</th><th>Type</th><th>SKU</th><th>Item</th>
                <th class="text-end text-nowrap">Δ&nbsp;Qty</th><th>UoM</th><th>Status</th><th>By</th><th>Note</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pagerLedger" class="d-flex justify-content-between align-items-center mt-2 small"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- Toast host (bottom-right) -->
  <div id="toastHost" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1080"></div>

  <!-- ===== Modals ===== -->
  <div class="modal fade" id="modalItemDetails" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-circle-info me-2"></i>Item Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><div id="itemDetailsBody"></div></div>
        <div class="modal-footer"><button class="btn btn-light-alt" data-bs-dismiss="modal">Close</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalSkuHistory" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-clock-rotate-left me-2"></i>SKU History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="skuHistoryBody"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light-alt" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-light-alt" id="btnExportSkuHistory">
            <i class="fa-solid fa-file-export me-1"></i>Export CSV
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm modal (Approve) -->
  <div class="modal fade" id="modalApprove" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-circle-question me-2"></i>Confirm Action — Approve
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 text-secondary">Please review the request summary, then confirm.</div>
          <div id="approveSummary" class="mb-3"></div>
          <label class="form-label">Comment (optional)</label>
          <textarea id="approveComment" class="form-control" rows="2" placeholder="Add a brief note (optional)"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="button" id="approveYes">
            <i class="fa-solid fa-check me-1"></i>Confirm Approve
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm modal (Decline) -->
  <div class="modal fade" id="modalConfirm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-circle-question me-2"></i>Confirm Action — Decline
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 text-secondary">Please review the request summary, then provide a reason.</div>
          <div id="confirmMessage" class="mb-3"></div>
          <label class="form-label">Reason (required)</label>
          <textarea id="confirmReason" class="form-control" rows="2" placeholder="Enter reason…" required></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" type="button" id="confirmYes">
            <i class="fa-solid fa-xmark me-1"></i>Confirm Decline
          </button>
        </div>
      </div>
    </div>
  </div>



  <!-- Confirm modal (User Accounts) -->
  <div class="modal fade" id="modalUserConfirm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userConfirmTitle">
            <i class="fa-solid fa-circle-question me-2"></i>Confirm user action
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="userConfirmSummary"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="button" id="userConfirmYes">Confirm</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Heads-up (Retired SKU) -->
  <div class="modal fade" id="modalRetiredHeadsUp" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>Heads-up
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          This SKU is currently <strong>RETIRED</strong>.<br>
          Your request will be sent as a single <strong>RECEIVE</strong>. When the controller approves,
          the item will be <strong>reactivated</strong> and the stock will be received in one step.
        </div>
        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" id="btnRetiredHeadsUpCancel" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="button" id="btnRetiredHeadsUpOk">
            <i class="fa-solid fa-check me-1"></i>Proceed
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create SKU -->
  <div class="modal fade" id="modalCreateSku" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form class="modal-content" id="formCreateSku">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-plus me-2"></i>Create SKUs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-secondary small">
              Add up to <b>10</b> items. SKUs will be <b>auto-generated</b> on submit.
            </div>
            <div><button type="button" class="btn btn-sm btn-light-alt" id="csAddRow">
              <i class="fa-solid fa-plus me-1"></i>Add item</button>
            </div>
          </div>

          <div id="csRows" class="vstack gap-2"></div>

          <div class="mt-3">
            <label class="form-label">Remarks</label>
            <textarea id="csNotes" class="form-control" rows="2" placeholder="Optional note…"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="submit">Submit for Approval</button>
        </div>
      </form>
    </div>
  </div>


  <!-- Modify SKU -->
  <div class="modal fade" id="modalModifySku" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form class="modal-content" id="formModifySku">
        <div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-2"></i>Modify Item</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">SKU</label><input id="msSku" class="form-control" list="skuList" placeholder="Search SKU" required><datalist id="skuList"></datalist></div>
            <div class="col-md-6"><label class="form-label">Item Name</label><input id="msName" class="form-control" required></div>
            <div class="col-md-6"><label class="form-label">Description</label><input id="msDesc" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">UoM</label><select id="msUom" class="form-select"></select></div>
            <div class="col-md-3"><label class="form-label">Location</label><input id="msLoc" class="form-control"></div>

            <div class="col-md-4">
              <label class="form-label">Category</label>
              <!-- from "Category" sheet (A=Name, B=Active) -->
              <select id="msCategory" class="form-select">
                <option value="" selected disabled>— Select Category —</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Status</label>
              <select id="msStatus" class="form-select">
                <option value="Active">Active</option>
                <option value="On Hold">On Hold</option>
              </select>
              <div class="form-text">Use <strong>On Hold</strong> to temporarily block issuance.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label">Unit Price</label>
              <div class="input-group">
                <span class="input-group-text">PHP</span>
                <input id="msPrice" type="number" step="0.01" min="0" class="form-control" placeholder="0.00">
              </div>
              <div class="form-text">Editing price creates a price-history entry.</div>
            </div>

            <div class="col-md-3 d-flex align-items-end">
              <button type="button" id="btnOpenPriceHistory" class="btn btn-light-alt w-100">
                <i class="fa-solid fa-clock-rotate-left me-1"></i>Price History
              </button>
            </div>

            <div class="col-12"><label class="form-label">Remarks</label><textarea id="msNotes" class="form-control" rows="2"></textarea></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button><button class="btn btn-success" type="submit">Submit for Approval</button></div>
      </form>
    </div>
  </div>

  <!-- Retire SKU -->
  <div class="modal fade" id="modalRetireSku" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <form class="modal-content" id="formRetireSku">
        <div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-box-archive me-2"></i>Retire SKU</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">SKU</label>
              <input id="rsSku" class="form-control" list="skuListRetire" placeholder="Only SKUs with 0 stock" required>
              <datalist id="skuListRetire"></datalist>
            </div>
            <div class="col-12"><label class="form-label">Remarks</label><textarea id="rsNotes" class="form-control" rows="2" placeholder="Reason"></textarea></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button><button class="btn btn-danger" type="submit">Submit for Approval</button></div>
      </form>
    </div>
  </div>

  <!-- Receive -->
  <div class="modal fade" id="modalReceive" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form class="modal-content" id="formReceive">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-inbox me-2"></i>Item Inbound / Receiving</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-secondary small">Add up to <b>10</b> items. No duplicate SKUs. Items must be <b>Active</b>.</div>
            <div><button type="button" class="btn btn-sm btn-light-alt" id="rcAddRow"><i class="fa-solid fa-plus me-1"></i>Add item</button></div>
          </div>

          <div id="rcRows" class="vstack gap-2"></div>

          <div class="mt-3">
            <label class="form-label">Remarks</label>
            <textarea id="rcNotes" class="form-control" rows="2" placeholder="Optional note…"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="submit">Submit Receipt</button>
        </div>
      </form>
    </div>
  </div>


  <!-- Issue -->
  <div class="modal fade" id="modalIssue" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form class="modal-content" id="formIssue">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-truck-arrow-right me-2"></i>Item Outbound / Issuing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-secondary small">Add up to <b>10</b> items. No duplicate SKUs. Items must be <b>Active</b>. Cannot exceed on-hand.</div>
            <div><button type="button" class="btn btn-sm btn-light-alt" id="isAddRow"><i class="fa-solid fa-plus me-1"></i>Add item</button></div>
          </div>

          <div id="isRows" class="vstack gap-2"></div>

          <!-- NEW required fields -->
          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <label class="form-label">Issued To — Employee Name</label>
              <input id="isEmp" class="form-control" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Business Unit</label>
              <!-- from "Business Unit" sheet (A=Name, B=Active) -->
              <select id="isBU" class="form-select" required>
                <option value="" selected disabled>— Select Business Unit —</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Department</label>
              <!-- from "Departments" sheet (A=Name, B=Active) -->
              <select id="isDept" class="form-select" required>
                <option value="" selected disabled>— Select Department —</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Deployment Location</label>
              <!-- from "Deployment Location" sheet (A=Name, B=Active) -->
              <select id="isDeployLoc" class="form-select" required>
                <option value="" selected disabled>— Select Deployment Location —</option>
              </select>
            </div>


            <div class="col-md-6">
              <label class="form-label">Reason for Pull-out</label>
              <textarea id="isReason" class="form-control" rows="1" placeholder="Brief reason" required></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-warning" type="submit">Submit Issue</button>
        </div>
      </form>
    </div>
  </div>


  <!-- Request Item (for Requestors) -->
  <div class="modal fade" id="modalRequest" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <form class="modal-content" id="formRequest">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-cart-shopping me-2"></i>Request Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="small text-secondary">
              Select up to <b>10</b> items. Only <b>Active</b> items are available.
            </div>
            <button type="button" class="btn btn-sm btn-success" id="rqOpenCatalog">
              <i class="fa-solid fa-plus me-1"></i>Select Items
            </button>
          </div>

          <!-- Cart / summary table -->
          <div id="rqCartWrap" class="border rounded p-2">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="rqCartTable">
                <thead>
                  <tr>
                    <th style="width:140px">SKU</th>
                    <th>Item</th>
                    <th>Item Description</th>
                    <th style="width:90px">UoM</th>
                    <th style="width:120px" class="text-end">On-hand</th>
                    <th style="width:140px" class="text-end">Qty to Request</th>
                    <th style="width:60px" class="text-end"></th>
                  </tr>
                </thead>
                <tbody><!-- rows injected --></tbody>
              </table>
            </div>
            <div class="small text-secondary mt-2" id="rqCartMeta">No items selected.</div>
          </div>

          <div class="mt-3">
            <label class="form-label">Reason / Purpose</label>
            <textarea id="rqReason" class="form-control" rows="2" placeholder="Brief justification" required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit" id="rqSubmitBtn">
            <i class="fa-solid fa-paper-plane me-1"></i>Submit Request
          </button>
        </div>
      </form>
    </div>
  </div>

  
  <div class="modal fade" id="modalMyReq" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-circle-info me-2"></i>Request Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><div id="myReqSummary"></div></div>
        <div class="modal-footer"><button class="btn btn-light-alt" data-bs-dismiss="modal">Close</button></div>
      </div>
    </div>
  </div>

  <!-- Select Items (catalog picker for Request flow) -->
  <div class="modal fade" id="modalSelectItems" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-magnifying-glass me-2"></i>Select Items to Request
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex flex-wrap gap-2 mb-2">
            <input id="catSearch" class="form-control form-control-sm search-input" placeholder="Search SKU / name / description" style="width:280px">
            <select id="catFilterCat" class="form-select form-select-sm" style="width:200px">
              <option value="">All Categories</option>
            </select>
            <select id="catFilterUom" class="form-select form-select-sm" style="width:140px">
              <option value="">All UoM</option>
            </select>
            <button id="catClear" class="btn btn-light-alt btn-sm">Clear</button>
            <div class="ms-auto small text-secondary">
              You can add up to <b>10</b> items in total.
            </div>
          </div>

          <div class="table-responsive">
            <table class="table align-middle table-hover" id="tblCatalog">
              <thead>
                <tr>
                  <th style="width:40px"></th>
                  <th>SKU</th>
                  <th>Item Name</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>UoM</th>
                  <th class="text-end">Available</th>
                  <th class="text-end" style="width:160px">Qty to Request</th>
                </tr>
              </thead>
              <tbody><!-- rows injected --></tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="button" id="catAddSelected">
            <i class="fa-solid fa-cart-plus me-1"></i>Add Selected Items
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Price Histotry -->

  <div class="modal fade" id="modalPriceHistory" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-tags me-2"></i>Price History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="priceHistoryBody" class="small">No price history.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light-alt" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Request (no "Select Items" button) -->
  <div class="modal fade" id="modalEditMyReq" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <form class="modal-content" id="formEditRequest">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-2"></i>Edit Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="small text-secondary">
              You can adjust quantities or remove items. Adding new items isn’t available here.
            </div>
          </div>

          <!-- Cart / summary table -->
          <div id="edCartWrap" class="border rounded p-2">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="edCartTable">
                <thead>
                  <tr>
                    <th style="width:140px">SKU</th>
                    <th>Item</th>
                    <th>Item Description</th>
                    <th style="width:90px">UoM</th>
                    <th style="width:120px" class="text-end">On-hand</th>
                    <th style="width:160px" class="text-end">Qty to Request</th>
                    <th style="width:60px" class="text-end"></th>
                  </tr>
                </thead>
                <tbody id="edCartBody"><!-- rows injected --></tbody>
              </table>
            </div>
            <div class="small text-secondary mt-2" id="edCartMeta">No items selected.</div>
          </div>

          <div class="mt-3">
            <label class="form-label">Reason / Purpose</label>
            <textarea id="edReason" class="form-control" rows="2" placeholder="Brief justification" required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light-alt" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" type="submit" id="edSubmitBtn">
            <i class="fa-solid fa-paper-plane me-1"></i>Save & Resubmit
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel My Request -->
  <div class="modal fade" id="modalCancelMyReq" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-ban me-2"></i>Cancel Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 text-secondary">This will void your current Pending request.</div>
          <label class="form-label">Reason (optional)</label>
          <textarea id="myCancelReason" class="form-control" rows="2" placeholder="Reason for cancellation"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light-alt" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-light-alt" id="myCancelGo">
            <i class="fa-solid fa-ban me-1"></i>Confirm Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="tplStockRow">
    <tr>
      <td><span class="sku-link text-decoration-underline" style="cursor:pointer"></span></td>
      <td><span class="item-name"></span></td>
      <td class="desc"></td>
      <td class="uom"></td>
      <td class="price text-end"></td>
      <td class="qty text-end"></td>
      <td class="cat"></td>
      <td class="status"></td>
      <td class="text-end">
        <div class="btn-group btn-group-sm">
          <button class="btn btn-light-alt btn-view"><i class="fa-solid fa-eye"></i></button>
          <button class="btn btn-light-alt btn-edit" data-bs-toggle="modal" data-bs-target="#modalModifySku"><i class="fa-solid fa-pen"></i></button>
          <button class="btn btn-outline-danger btn-retire"><i class="fa-solid fa-box-archive"></i></button>
        </div>
      </td>
    </tr>
  </template>

  <template id="tplPendingRow">
    <tr>
      <td class="when"></td><td class="type"></td><td class="sku"></td><td class="details"></td><td class="by"></td><td class="approver"></td>
      <td class="text-end">
        <div class="btn-group btn-group-sm">
          <button class="btn btn-success btn-approve" title="Approve"><i class="fa-solid fa-check"></i></button>
          <button class="btn btn-danger btn-decline" title="Decline"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </td>
    </tr>
  </template>

  <template id="tplMineRow">
    <tr>
      <td class="when"></td>
      <td class="status"></td>
      <td class="sku"></td>
      <td class="name"></td>
      <td class="qty text-end"></td>
      <td class="uom"></td>
      <td class="recid text-muted"></td>
      <td class="current-approver text-end"></td>
      <td class="text-end">
        <div class="btn-group btn-group-sm">
          <button class="btn btn-light-alt btn-view-req"   title="View"><i class="fa-solid fa-eye"></i></button>
          <button class="btn btn-light-alt btn-edit-req"   title="Edit (while Pending)"><i class="fa-solid fa-pen-to-square"></i></button>
          <button class="btn btn-light-alt btn-cancel-req" title="Cancel (void)"><i class="fa-solid fa-ban"></i></button>
        </div>
      </td>
    </tr>
  </template>

  <template id="tplLedgerRow">
    <tr>
      <td class="id"></td><td class="when"></td><td class="type"></td><td class="sku"></td><td class="name"></td>
      <td class="delta text-end"></td><td class="uom"></td><td class="status"></td><td class="by"></td><td class="note"></td>
    </tr>
  </template>

  <template id="tplCreateRow">
    <div class="border rounded p-2">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Item Name</label>
          <input class="form-control cr-name" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Category</label>
          <select class="form-select cr-cat">
            <option value="" selected disabled>— Select Category —</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">UoM</label>
          <select class="form-select cr-uom"></select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Location</label>
          <input class="form-control cr-loc" placeholder="Main WH">
        </div>
        <div class="col-md-2">
          <label class="form-label">Unit Price</label>
          <input type="number" step="0.01" min="0" class="form-control cr-price" placeholder="0.00">
        </div>
        <div class="col-md-10">
          <label class="form-label">Description</label>
          <input class="form-control cr-desc" placeholder="">
        </div>
        <div class="col-md-2 d-grid">
          <button type="button" class="btn btn-light-alt cr-del">
            <i class="fa-solid fa-trash-can me-1"></i>Remove
          </button>
        </div>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const fmt = n => Number(n||0).toLocaleString();
    const money = n => (n===null || n===undefined || n==='') ? '—'
      : new Intl.NumberFormat('en-PH',{ style:'currency', currency:'PHP', maximumFractionDigits:2 }).format(Number(n));
    const when = iso => {
      if (!iso) return '—';
      const d = new Date(iso);
      return isNaN(d) ? '—' : d.toLocaleString();
    };

    function setLoading(btn, on, text){
      if(!btn) return;
      if(on){
        if(!btn.dataset.prevHtml) btn.dataset.prevHtml = btn.innerHTML;
        btn.disabled = true;
        btn.classList.add('btn-loading');
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>${text || btn.textContent.trim()}`;
      }else{
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        if(btn.dataset.prevHtml){ btn.innerHTML = btn.dataset.prevHtml; delete btn.dataset.prevHtml; }
      }
    }

    // ===== Animation utilities =====
    const EASE = { outCubic: t => 1 - Math.pow(1 - t, 3) };
    const KPI_PREV = { activeSkus:0, onhand:0, pending:0, ledger:0 };
    function animateNumber(el, from, to, ms=700){
      const start = performance.now();
      function frame(t){
        const p = Math.min(1, (t - start) / ms);
        const v = Math.round(from + (to - from) * EASE.outCubic(p));
        el.textContent = Number(v).toLocaleString();
        if (p < 1) requestAnimationFrame(frame);
        else { el.classList.remove('kpi-pop'); void el.offsetWidth; el.classList.add('kpi-pop'); }
      }
      requestAnimationFrame(frame);
    }

    function setupReveals(){
      const obs = new IntersectionObserver((ents)=>{
        ents.forEach(e=>{
          if(e.isIntersecting){ e.target.classList.add('show'); obs.unobserve(e.target); }
        });
      }, { threshold: 0.12 });

      document.querySelectorAll('.card').forEach(el=>{
        el.classList.add('anim-reveal');
        obs.observe(el);
      });
    }

    function enableRipples(){
      document.body.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('.btn');
        if(!btn) return;
        const r = document.createElement('span');
        r.className = 'ripple';
        const rect = btn.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        r.style.width = r.style.height = size + 'px';
        r.style.left = (ev.clientX - rect.left - size/2) + 'px';
        r.style.top  = (ev.clientY - rect.top  - size/2) + 'px';
        btn.appendChild(r);
        setTimeout(()=> r.remove(), 650);
      });
    }

    // ---- Pagination (8 per page) ----
    const PAGE = { stock: 1, pending: 1, ledger: 1, mine: 1 };
    const PAGE_SIZE = 8;
    const LAST = { stock: [], pending: [], ledger: [], mine: [] };

    function getPage(list, page, size){
      const total = list.length;
      const pages = Math.max(1, Math.ceil(total / size));
      const p = Math.min(Math.max(1, page), pages);
      const startIdx = total ? (p - 1) * size : 0;
      const endIdx = total ? Math.min(startIdx + size, total) : 0;
      return { rows: list.slice(startIdx, endIdx), total, pages, page: p, start: total ? startIdx + 1 : 0, end: endIdx };
    }
    function renderPager(which, containerId, pg){
      const el = document.getElementById(containerId); if (!el) return;
      el.innerHTML = `
        <div>Showing ${pg.start}–${pg.end} of ${pg.total}</div>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-light-alt" ${pg.page<=1?'disabled':''} id="${containerId}-prev">Prev</button>
          <span class="btn btn-light-alt disabled">Page ${pg.page} / ${pg.pages}</span>
          <button class="btn btn-light-alt" ${pg.page>=pg.pages?'disabled':''} id="${containerId}-next">Next</button>
        </div>`;
      document.getElementById(`${containerId}-prev`)?.addEventListener('click', ()=>{ PAGE[which] = Math.max(1, pg.page - 1); RENDER[which](); });
      document.getElementById(`${containerId}-next`)?.addEventListener('click', ()=>{ PAGE[which] = Math.min(pg.pages, pg.page + 1); RENDER[which](); });
    }
    const RENDER = {
      stock:   ()=> renderItems(BOOT.items),
      pending: ()=> renderPending(BOOT.pending),
      ledger:  ()=> renderLedger(BOOT.ledger),
      mine:    ()=> renderMine(BOOT.minePending || [])
    };

    // ---- UoM master list ----
    const UOMS = ['pc','pcs','pair','set','pack','box','case','carton','kit','spool','roll','bag','bottle','can','tube','sheet','pad','ream','unit','kg','g','mg','lb','oz','L','mL','m','cm','mm','ft','in','sq m','sq ft'];

    const COLS_STOCK = [
      { key:'SKU', header:'SKU' },{ key:'Name', header:'Item Name' },{ key:'Description',header:'Description' },
      { key:'Category', header:'Category' },
      { key:'UoM', header:'UoM' },
      { key:'UnitPrice', header:'Unit Price', value: it => computeDisplayUnitPrice(it) },
      { key:'Qty', header:'On-hand' },{ key:'Status', header:'Status' }
    ];



    const COLS_PENDING = [
      { key:'When', header:'When' },{ key:'Type', header:'Type' },{ key:'SKU', header:'SKU' },{ key:'Name', header:'Name' },
      { key:'Qty', header:'Qty' },{ key:'Delta', header:'Delta' },{ key:'UoM', header:'UoM' },{ key:'By', header:'Requested By' },
      { key:'CurrentApprover', header:'Current Approver' },
      { key:'Status', header:'Status' },{ key:'Reason', header:'Reason' },{ key:'Note', header:'Note' },
      { key:'PendingID', header:'PendingID' },{ key:'LinkID', header:'LinkID' }
    ];
    const COLS_LEDGER = [
      { key:'ID', header:'ID' },{ key:'When', header:'When' },{ key:'Type', header:'Type' },{ key:'SKU', header:'SKU' },
      { key:'Item', header:'Item' },{ key:'Delta', header:'Delta' },{ key:'UoM', header:'UoM' },
      { key:'Status', header:'Status' },{ key:'By', header:'By' },{ key:'Note', header:'Note' }
    ];

    const COLS_MINE = [
      { key:'When', header:'When' },
      { key:'Status', header:'Status' },
      { key:'SKU', header:'SKU' },
      { key:'Item', header:'Item' },
      { key:'Qty', header:'Qty' },
      { key:'UoM', header:'UoM' },
      { key:'Note', header:'Note' },
      { key:'Reason', header:'Reason' },
      { key:'RecordID', header:'Record ID' }
    ];

    // ===== Helpers to render organized details =====
    function activeNames(list){
      return (list || [])
        .filter(r => String(r.Active || r.active || '').toLowerCase() !== 'no')
        .map(r => r.Name || r.name)
        .filter(Boolean);
    }
    function populateBusinessUnitSelect(buList){
      const sel = document.getElementById('isBU'); if (!sel) return;
      const keep = sel.querySelector('option[value=""]')?.outerHTML || '<option value="" disabled selected>— Select Business Unit —</option>';
      const opts = activeNames(buList).map(n => `<option value="${n}">${n}</option>`).join('');
      sel.innerHTML = keep + opts;
    }
    function populateDepartmentSelect(deptList){
      const sel = document.getElementById('isDept'); if (!sel) return;
      const keep = sel.querySelector('option[value=""]')?.outerHTML || '<option value="" disabled selected>— Select Department —</option>';
      const opts = activeNames(deptList).map(n => `<option value="${n}">${n}</option>`).join('');
      sel.innerHTML = keep + opts;
    }
    function populateDeployLocationSelect(deployList){
      const sel = document.getElementById('isDeployLoc'); if (!sel) return;
      const keep = sel.querySelector('option[value=""]')?.outerHTML || '<option value="" disabled selected>— Select Deployment Location —</option>';
      const opts = activeNames(deployList).map(n => `<option value="${n}">${n}</option>`).join('');
      sel.innerHTML = keep + opts;
    }

    // NEW: Category (used by Modify form + Create rows + Stock filter)
    function populateCategoryOptions(catList, selectEl){
      if (!selectEl) return;
      const keep = selectEl.querySelector('option[value=""]')?.outerHTML || '<option value="">All Categories</option>';
      const opts = activeNames(catList).map(n => `<option value="${n}">${n}</option>`).join('');
      selectEl.innerHTML = keep + opts;
    }
    function populateCategorySelects(catList){
      populateCategoryOptions(catList, document.getElementById('msCategory'));
      // For existing Create rows (if modal already open)
      document.querySelectorAll('#csRows .cr-cat').forEach(el => populateCategoryOptions(catList, el));
    }


    // ===== Create SKUs (multi) =====
    function crMakeRow(){
      const tpl = document.getElementById('tplCreateRow');
      const node = tpl.content.firstElementChild.cloneNode(true);

      // default Location
      const locInp = node.querySelector('.cr-loc');
      if (locInp) locInp.value = 'Head Office';

      // populate Category (from BOOT lookups)
      const catSel = node.querySelector('.cr-cat');
      if (catSel) {
        const cats = (BOOT?.categories || BOOT?.lookups?.categories || []);
        const keep = '<option value="" selected disabled>— Select Category —</option>';
        const opts = activeNames(cats).map(n => `<option value="${n}">${n}</option>`).join('');
        catSel.innerHTML = keep + opts;
      }

      // populate UoM
      const uomSel = node.querySelector('.cr-uom');
      uomSel.innerHTML = '<option value="" disabled selected>— Select UoM —</option>'
        + UOMS.map(u => `<option value="${u}">${u}</option>`).join('');

      return node;
    }

    function crReset(n=1){
      const host = document.getElementById('csRows');
      if (!host) return;
      host.innerHTML = '';
      for (let i=0;i<n;i++) host.appendChild(crMakeRow());
    }
    document.getElementById('modalCreateSku')?.addEventListener('shown.bs.modal', ()=> crReset(1));

    // Add / Remove rows (event delegation)
    document.addEventListener('click', (ev)=>{
      if (ev.target.closest('#csAddRow')) {
        const host = document.getElementById('csRows');
        if (!host) return;
        if (host.children.length >= 10) {
          (window.toast ? toast({ title:'Limit', message:'Max 10 items per request.', type:'warning' }) : alert('Max 10 items per request.'));
          return;
        }
        host.appendChild(crMakeRow());
      }
      if (ev.target.closest('.cr-del')) {
        ev.preventDefault();
        ev.target.closest('.border.rounded')?.remove();
      }
    });

    // Submit Create SKUs (multi)
    document.getElementById('formCreateSku')?.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      ev.stopPropagation();

      const btn  = ev.submitter;
      const host = document.getElementById('csRows');
      const note = document.getElementById('csNotes')?.value || '';

      const items = Array.from(host?.children || []).map(card => ({
        sku: '',
        name:  (card.querySelector('.cr-name')?.value  || '').trim(),
        category: (card.querySelector('.cr-cat')?.value || '').trim(),
        uom:   (card.querySelector('.cr-uom')?.value   || '').trim(),
        desc:  (card.querySelector('.cr-desc')?.value  || '').trim(),
        loc:   (card.querySelector('.cr-loc')?.value   || '').trim(),
        price: parseFloat(card.querySelector('.cr-price')?.value || '') || null
      })).filter(it => it.name);



      if (!items.length) {
        (window.toast ? toast({ message:'Add at least one item.', type:'warning' }) : alert('Add at least one item.'));
        return false;
      }

      setLoading(btn, true, 'Submitting…');

      google.script.run
        .withSuccessHandler(() => {
          setLoading(btn, false);
          (window.toast ? toast({ title:'Submitted', message:'Create request sent for approval.', type:'success' }) : alert('Submitted.'));

          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('modalCreateSku'))?.hide();

          // 🔁 Refresh the app data without leaving the page
          google.script.run
            .withSuccessHandler(fresh => {
              // rebind the global state if you use it
              window.BOOT = fresh;

              // re-render sections (use whatever you already have)
              RENDER.stock();
              RENDER.pending();
              RENDER.ledger();
              RENDER.mine?.();

              // clear the form for next time
              document.getElementById('csRows').innerHTML = '';
              document.getElementById('csNotes').value = '';
            })
            .withFailureHandler(e => {
              const msg = e?.message || String(e);
              (window.toast ? toast({ title:'Reload failed', message: msg, type:'danger' }) : alert('Reload error: ' + msg));
              // last resort: hard reload
              window.location.reload();
            })
            .getBootstrap();
        })
        .withFailureHandler(e => {
          setLoading(btn, false);
          const msg = e?.message || String(e);
          (window.toast ? toast({ title:'Error', message: msg, type:'danger' }) : alert('Error: ' + msg));
        })
        .actionCreateSkus(items, note);

      return false;
    });



    function formatSkuChips(csv){
      const parts = String(csv||'').split(',').map(s => s.trim()).filter(Boolean);
      if(!parts.length) return '—';
      return parts.map(code => `<span class="badge bg-secondary-subtle text-dark me-1 mb-1">${code}</span>`).join('');
    }

    function extractItemsFromPayload(row){
      try{
        const p = row && row.PayloadJSON ? JSON.parse(row.PayloadJSON) : null;
        if(p && Array.isArray(p.items) && p.items.length){
          return p.items.map(it => ({
            sku: it.SKU, name: it.Name, qty: it.qty, uom: it.UoM
          }));
        }
      }catch(e){}
      // fallback for single
      if(row && row.Name){
        return [{ sku: row.SKU, name: row.Name, qty: row.Qty, uom: row.UoM }];
      }
      return [];
    }

    function buildDetailsHTML(row){
      const items = extractItemsFromPayload(row);
      const list = items.length
        ? `<ol class="mb-1">${items.map(it => `<li>${(it.qty ?? '—')} ${it.uom ?? ''} — ${it.name ?? '—'} <span class="text-secondary">(${it.sku ?? '—'})</span></li>`).join('')}</ol>`
        : '—';

      // User’s notes/remarks/reason (gray at the bottom)
      // Prefer structured payload fields if present
      let userNote = '';
      try{
        const p = row && row.PayloadJSON ? JSON.parse(row.PayloadJSON) : null;
        const bits = [];
        if(p && p.reason) bits.push(`Reason: ${p.reason}`);
        if(p && p.note)   bits.push(`Note: ${p.note}`);
        if(!bits.length){
          if(row.Reason) bits.push(`Reason: ${row.Reason}`);
          if(row.Note)   bits.push(`Note: ${row.Note}`);
        }
        if(bits.length) userNote = `<div class="small text-secondary">${bits.join(' · ')}</div>`;
      }catch(e){
        const fallback = [row.Reason && `Reason: ${row.Reason}`, row.Note && `Note: ${row.Note}`].filter(Boolean);
        if(fallback.length) userNote = `<div class="small text-secondary">${fallback.join(' · ')}</div>`;
      }

      return list + userNote;
    }

    function buildApproveSummaryHTML(row){
      const itemsHTML = buildDetailsHTML(row); // already includes items list + gray user comment
      return `
        <div class="mb-1"><b>Type:</b> ${row.Type}</div>
        <div class="mb-1"><b>Pending ID:</b> ${row.PendingID}</div>
        <div class="mb-1"><b>SKU:</b> ${formatSkuChips(row.SKU)}</div>
        <div class="mt-2">${itemsHTML}</div>
      `;
    }

    function populateUomSelect(selectEl, selectedValue){
      if (!selectEl) return;
      selectEl.innerHTML = '<option value="" disabled>— Select UoM —</option>' + UOMS.map(u => `<option value="${u}">${u}</option>`).join('');
      if (selectedValue && !UOMS.includes(String(selectedValue))) {
        const opt = document.createElement('option'); opt.value = selectedValue; opt.textContent = `${selectedValue} (custom)`; selectEl.appendChild(opt);
      }
      selectEl.value = selectedValue || '';
    }

    let BOOT = null;
    const SKU_HIST_CACHE = new Map();

    function toast(opts, maybeType){
      // Backward compatible: toast('message', 'info')
      if (typeof opts === 'string') opts = { message: opts, type: (maybeType || 'info') };

      const { title, message, type='info', timeout=4000 } = (opts || {});
      const ICONS = {
        success:'fa-circle-check',
        info:'fa-circle-info',
        warning:'fa-triangle-exclamation',
        danger:'fa-circle-xmark',
        default:'fa-bell'
      };

      const host = document.getElementById('toastHost');
      if(!host){ alert(message || title || ''); return; }

      const el = document.createElement('div');
      el.className = `toast toast-${type}`;
      el.setAttribute('role','status');
      el.setAttribute('aria-live','polite');
      el.setAttribute('aria-atomic','true');

      const icon = ICONS[type] || ICONS.default;
      el.innerHTML = `
        <div class="toast-body">
          <i class="fa-solid ${icon} toast-icon"></i>
          <div class="content">
            ${title ? `<div class="title">${title}</div>` : ''}
            ${message ? `<div class="msg">${message}</div>` : ''}
            <div class="meta">${new Date().toLocaleTimeString()}</div>
          </div>
          <button class="toast-close" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
          <div class="toast-progress" style="animation-duration:${timeout}ms"></div>
        </div>
      `;

      host.appendChild(el);
      el.classList.add('toast-pop');

      const inst = new bootstrap.Toast(el, { autohide: true, delay: timeout });
      el.querySelector('.toast-close').addEventListener('click', () => inst.hide());
      el.addEventListener('hidden.bs.toast', () => el.remove());
      inst.show();
    }

    function uniqueSorted(arr){ return Array.from(new Set((arr||[]).filter(Boolean))).sort(); }
    function populateStockFilters(items){
      const cats = uniqueSorted(items.map(i => i.Category).filter(Boolean));
      const uoms = uniqueSorted(items.map(i => i.UoM));
      const cSel = $('#stockFilterCat'); if (cSel){ cSel.innerHTML = '<option value="">All Categories</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join(''); }
      const uSel = $('#stockFilterUom'); if (uSel){ uSel.innerHTML = '<option value="">All UoM</option>' + uoms.map(u=>`<option value="${u}">${u}</option>`).join(''); }
    }


    function populatePendingFilters(pending){
      const types = uniqueSorted((pending||[]).map(p => p.Type));
      const bys   = uniqueSorted((pending||[]).map(p => p.By));
      const roles = Array.from(new Set((pending||[])
                      .map(p => String(p.CurrentApproverRole||'').toLowerCase())
                      .filter(Boolean))).sort();

      const tSel = $('#pendFilterType');
      if (tSel) tSel.innerHTML = '<option value="">All Types</option>' + types.map(t=>`<option value="${t}">${t}</option>`).join('');

      const bSel = $('#pendFilterBy');
      if (bSel) bSel.innerHTML = '<option value="">All Requesters</option>' + bys.map(b=>`<option value="${b}">${b}</option>`).join('');

      const aSel = $('#pendFilterApprover');
      if (aSel) {
        const label = r => (r==='manager' ? 'Managers' : r==='controller' ? 'Controllers' : r);
        const keep  = aSel.querySelector('option[value=""]')?.outerHTML || '<option value="">All Approvers</option>';
        aSel.innerHTML = keep + roles.map(r => `<option value="${r}">${label(r)}</option>`).join('');
      }
    }
    function populateLedgerFilters(ledger){
      const types = uniqueSorted(ledger.map(l => l.Type));
      const tSel = $('#ledgerFilterType'); if(tSel){ tSel.innerHTML = '<option value="">All Types</option>' + types.map(t=>`<option value="${t}">${t}</option>`).join(''); }
    }

    function csvEscape(v){
      if (v === null || v === undefined) return '';
      const s = String(v).replace(/"/g, '""');
      return /[",\n]/.test(s) ? `"${s}"` : s;
    }
    function downloadCSV(filename, rows, columns){
      if (!rows || rows.length === 0){
        toast('Nothing to export for current filters','warning');
        return;
      }
      const header = columns.map(c => csvEscape(c.header)).join(',');
      const body = rows.map(r => columns.map(c => csvEscape(typeof c.value === 'function' ? c.value(r) : r[c.key])).join(',')).join('\n');
      const csvText = '\ufeff' + header + '\n' + body;
      const blob = new Blob([csvText], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    // ===== SKU History (robust: handles multi-item rows) =====
    function openSkuHistory(sku){
      const item = (BOOT.items||[]).find(x => String(x.SKU) === String(sku));
      const body = document.getElementById('skuHistoryBody');
      const modalEl = document.getElementById('modalSkuHistory');
      if(!item || !body || !modalEl) return;

      // open modal with a tiny loader immediately
      body.innerHTML = `
        <div class="p-3 border rounded-3 mb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-secondary small">SKU</div>
              <div class="fs-5 fw-semibold">${item.SKU}</div>
              <div class="h5 mb-0">${item.Name}</div>
            </div>
            <div>${
              item.Status==='Active'
                ? '<span class="badge text-bg-success">Active</span>'
                : item.Status==='On Hold'
                  ? '<span class="badge text-bg-warning text-dark">On Hold</span>'
                  : '<span class="badge text-bg-secondary">Retired</span>'
            }</div>
          </div>
          <div class="text-secondary small mt-2">${item.Description || ''}</div>
        </div>
        <div class="d-flex align-items-center gap-2 text-secondary">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Building history…
        </div>`;
      bootstrap.Modal.getOrCreateInstance(modalEl).show();

      // helper: include CREATE_SKU robustly for every created SKU
      function itemsFromRow(row){
        // 1) structured payload first
        try{
          const p = row?.PayloadJSON ? JSON.parse(row.PayloadJSON) : null;
          if (p && Array.isArray(p.items) && p.items.length){
            // Special case: CREATE_SKU often has items without qty/uom
            if (row?.Type === 'CREATE_SKU'){
              const items = p.items.map(it => ({
                qty: null,
                uom: '',
                name: it.Name ?? it.name ?? '',
                sku:  it.SKU  ?? it.sku  ?? ''
              }));
              // If names are missing, enrich via BOOT lookup
              const haveAnyName = items.some(it => (it.name || '').trim());
              if (!haveAnyName) {
                const skus = items.map(it => it.sku).filter(Boolean);
                const looked = _namesFromSkus(skus);
                if (looked.length) return looked;
              }
              return items;
            }
            // Default mapping for non-CREATE rows
            return p.items.map(it => ({
              qty: it.qty ?? it.Qty ?? row.Delta ?? row.Qty ?? null,
              uom: it.UoM ?? it.uom ?? row.UoM ?? '',
              name: it.Name ?? it.name ?? row.Item ?? row.Name ?? '',
              sku:  it.SKU  ?? it.sku  ?? row.SKU  ?? ''
            }));
          }
        }catch(_){}

        // 2) CREATE_SKU fallback when payload is empty / missing
        if (row?.Type === 'CREATE_SKU'){
          const skus = new Set();

          // A) row.SKU may be a CSV list for batch create
          if (row?.SKU) {
            String(row.SKU).split(/\s*,\s*/).forEach(s => { if (s) skus.add(s.trim()); });
          }

          // B) Parse summary in Note: "... (SKU1, SKU2, ...)"
          if (row?.Note) {
            const m = String(row.Note).match(/\(([^)]+)\)/);
            if (m && m[1]) {
              m[1].split(/\s*,\s*/).forEach(s => { if (s) skus.add(s.trim()); });
            }
          }

          const items = _namesFromSkus([...skus]); // -> [{name, sku}]
          if (items.length) return items;
          // If still nothing, fall through to generic paths below (very rare)
        }

        // 3) parse note lines like "3 pcs — Name (SKU)"
        const re = /^\s*(?:\d+\.\s*)?(-?\d+(?:\.\d+)?)\s+(.+?)\s*[—–-]\s*(.+?)\s*\(\s*([^)]+)\s*\)\s*$/;
        const lines = String(row?.Note||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
        const parsed = lines.map(l => {
          const m = l.match(re); if(!m) return null;
          return { qty:Number(m[1]), uom:m[2], name:m[3], sku:m[4] };
        }).filter(Boolean);
        if (parsed.length) return parsed;

        // 4) single-row fallback
        if (row && (row.SKU || row.Name || row.Item)) {
          return [{ qty: row.Delta ?? row.Qty ?? null, uom: row.UoM || '', name: row.Item || row.Name || '', sku: row.SKU || '' }];
        }
        return [];
      }

      function signDelta(rowType, rawQty){
        if (rawQty == null || rawQty === '') return null;
        const n = Number(rawQty);
        if (Number.isNaN(n)) return null;
        if (rowType === 'ISSUE')   return -Math.abs(n);
        if (rowType === 'RECEIVE') return  Math.abs(n);
        // CREATE/MODIFY/RETIRE/etc.: no stock delta
        return null;
      }

      function mergedNoteForRow(row, includeLine){
        return mergedNote(row, includeLine && includeLine.trim());
      }

      // build per-SKU history
      const out = [];
      for (const r of (BOOT.ledger || [])) {
        const list = itemsFromRow(r);
        if (!list.length){
          // still include direct matches when the row itself is for this SKU
          if (String(r.SKU) === String(sku)) {
            out.push({
              when: r.When, type: r.Type, delta: Number(r.Delta ?? r.Qty ?? null),
              uom: r.UoM || '', status: r.Status, by: r.By || '', note: mergedNoteForRow(r), id: r.ID
            });
          }
          continue;
        }
        // pick only the line that matches this SKU (if present)
        const hit = list.find(it => String(it.sku) === String(sku));
        if (!hit) continue;

        const delta = signDelta(r.Type, hit.qty);
        // For CREATE_SKU, include a clearer per-line note "Name (SKU)"
        const line = (r.Type === 'CREATE_SKU')
          ? `${hit.name || ''} (${hit.sku || ''})`
          : `${hit.qty ?? '—'} ${hit.uom || ''} — ${hit.name || ''} (${hit.sku || ''})`;

        out.push({
          when: r.When,
          type: r.Type,
          delta,
          uom: hit.uom || r.UoM || '',
          status: r.Status,
          by: r.By || '',
          note: mergedNoteForRow(r, line),
          id: r.ID
        });
      }

      // newest first
      out.sort((a,b) => new Date(b.when) - new Date(a.when));

      // render table
      body.innerHTML = `
        <div class="p-3 border rounded-3 mb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-secondary small">SKU</div>
              <div class="fs-5 fw-semibold">${item.SKU}</div>
              <div class="h5 mb-0">${item.Name}</div>
            </div>
            <div>${
              item.Status==='Active'
                ? '<span class="badge text-bg-success">Active</span>'
                : item.Status==='On Hold'
                  ? '<span class="badge text-bg-warning text-dark">On Hold</span>'
                  : '<span class="badge text-bg-secondary">Retired</span>'
            }</div>
          </div>
          <div class="text-secondary small mt-2">${item.Description || ''}</div>
        </div>

        <div class="history-wrap">
          ${out.length ? `
            <table class="table sku-history-table align-middle table-hover table-striped">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Type</th>
                  <th class="text-end">Δ Qty</th>
                  <th>UoM</th>
                  <th>Status</th>
                  <th>By</th>
                  <th>Note</th>
                  <th class="text-muted">Ledger ID</th>
                </tr>
              </thead>
              <tbody>
                ${out.map(l => `
                  <tr>
                    <td class="when">${when(l.when)}</td>
                    <td class="type">${typeBadge(l.type)}</td>
                    <td class="delta">${qtyBadge(l.delta)}</td>
                    <td class="uom">${l.uom || ''}</td>
                    <td class="status">${statusBadge(l.status)}</td>
                    <td class="by">${l.by || ''}</td>
                    <td class="note">${(l.note || '').replace(/\n/g,'<br>')}</td>
                    <td class="id">${l.id || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>` : `<div class="text-secondary small">No history yet for this SKU.</div>`}
        </div>
      `;

      // CSV export
      const cols = [
        { header:'When',      value:r => r.when },
        { header:'Type',      value:r => r.type },
        { header:'Ledger ID', value:r => r.id },
        { header:'Delta',     value:r => r.delta },
        { header:'UoM',       value:r => r.uom },
        { header:'Status',    value:r => r.status },
        { header:'By',        value:r => r.by },
        { header:'Note',      value:r => r.note }
      ];
      const btn = document.getElementById('btnExportSkuHistory');
      if (btn) btn.onclick = () => downloadCSV(`${item.SKU}-history.csv`, out, cols);
    }

    // ===== Loader util =====
    const Loader = (() => {
      const el   = document.getElementById('appLoader');
      const msg  = document.getElementById('loaderMsg');
      const tip  = document.getElementById('loaderTip');
      const tips = [
        'Tip: Click a SKU to view its history.',
        'Tip: Use the search bars to filter instantly.',
        'Tip: Export CSV from the top-right of each section.',
        'Tip: Controllers approve via Approvals → Transactions.'
      ];
      let timer = null, i = 0;

      function startTips(){
        clearInterval(timer);
        timer = setInterval(() => { if(tip) tip.textContent = tips[(i++) % tips.length]; }, 1800);
      }

      return {
        show(message){
          if(!el) return;
          el.style.display = 'flex';
          el.classList.remove('hidden');
          if(msg) msg.textContent = message || 'Loading…';
          startTips();
        },
        message(m){ if(msg) msg.textContent = m || 'Loading…'; },
        hide(){
          if(!el) return;
          el.classList.add('hidden');
          clearInterval(timer);
          setTimeout(() => { el.style.display = 'none'; }, 320);
        }
      };
    })();

    // ===== Boot / Reload =====
    function loadApp(opts){
      const silent = !!(opts && (opts.silent || opts.reload));
      if (!silent) { try { Loader.show('Connecting to data…'); } catch(e) {} }

      google.script.run
        .withSuccessHandler(payload => {
          const setMsg = m => { if (!silent) { try { Loader.message(m); } catch(e) {} } };
          BOOT = payload;

          // Header / identity
          if (payload.user?.email) {
            const who = document.getElementById('whoami');
            if (who) {
              who.classList.remove('d-none');
              who.textContent = `${payload.user.email} — ${payload.user.role || 'user'}`;
            }
            document.getElementById('switchLink')?.classList.remove('d-none');
          }
          if (payload.db) {
            const chip = document.getElementById('dbChip');
            if (chip) { chip.classList.remove('d-none'); chip.textContent = payload.db.name; }
          }
          // NEW: last sync chip
          const syncChip = document.getElementById('syncChip');
          if (syncChip && payload.serverNow) {
            const t = new Date(payload.serverNow);
            syncChip.classList.remove('d-none');
            syncChip.textContent = `Synced ${isNaN(t) ? '' : t.toLocaleTimeString()}`;
          }

          // Route: login vs app
          const st = payload.user?.status || 'Unknown';
          const goLogin = (panelId, allowCreate=false) => { showLogin(panelId, allowCreate); if (!silent) { try { Loader.hide(); } catch(e) {} } };
          const loginEmail = document.getElementById('loginEmail');
          if (loginEmail) loginEmail.textContent = payload.user?.email || '—';

          ['stateNoSession','stateUnknown','statePending','stateDisabled'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('d-none');
          });
          document.getElementById('createAccountWrap')?.classList.add('d-none');

          if (st === 'NoSession') return goLogin('stateNoSession');
          if (st === 'Unknown')   return goLogin('stateUnknown', true);
          if (st === 'Pending')   return goLogin('statePending');
          if (st === 'Disabled')  return goLogin('stateDisabled');

          // Active user → show app
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('appScreen').style.display = 'block';

          const role = payload.user.role || '';
          const isController = role === 'controller';
          const canApprove = role === 'controller' || role === 'manager';

          if (canApprove) {
            document.getElementById('approvalsWrap').style.display = 'block';
          }

          if (isController) {
            document.getElementById('toolsMenu')?.classList.remove('d-none');
          } else {
            document.querySelector('button[data-bs-target="#tabUsers"]')?.closest('li')?.classList.add('d-none');
            document.getElementById('tabUsers')?.classList.add('d-none');
          }

          // Decide user mode FIRST so initial renders use correct filters
          applyUserMode(payload);

          // Build UI (silent mode skips loader messages)
          // For requestors, compute KPIs by DISTINCT request (not items)
          if (IS_USER) {
            const myEmail = String(payload.user?.email || '').toLowerCase();

            // Prefer backend-provided mine*; else filter globals by signed-in user
            const mineP = Array.isArray(payload.minePending)
              ? payload.minePending.filter(p => p.Type === 'ISSUE' && String(p.By||'').toLowerCase() === myEmail)
              : (payload.pending || []).filter(p => p.Type === 'ISSUE' && String(p.By||'').toLowerCase() === myEmail);

            const mineL = Array.isArray(payload.mineLedger)
              ? payload.mineLedger.filter(l => l.Type === 'ISSUE' && String(l.By||'').toLowerCase() === myEmail)
              : (payload.ledger  || []).filter(l => l.Type === 'ISSUE' && String(l.By||'').toLowerCase() === myEmail);

            // Robust request key across Pending/Ledger
            const reqKey = r => String(
              r.PendingID ?? r.RecordID ?? r.LinkID ?? r.LinkId ?? r.ID ?? r.Id ?? ''
            ).trim() || `${r.Type||'ISSUE'}|${r.When||''}|${r.By||''}`;

            const now = new Date();
            const cutoff = new Date(now.getTime() - 30*24*60*60*1000);

            // 1) Open Requests = distinct Pending
            const open = new Set(mineP.filter(p => p.Status === 'Pending').map(reqKey)).size;

            // 2) Approved (30d) = distinct approved in ledger within 30 days
            const approved30 = new Set(
              mineL.filter(l => l.Status === 'Approved' && new Date(l.When) >= cutoff).map(reqKey)
            ).size;

            // 3) Declined (30d) = distinct declined (either in ledger or still in pending) within 30 days
            const declined30 = new Set([
              ...mineL.filter(l => l.Status === 'Declined' && new Date(l.When) >= cutoff).map(reqKey),
              ...mineP.filter(p => p.Status === 'Declined' && new Date(p.When) >= cutoff).map(reqKey),
            ]).size;

            // 4) Total Requested = distinct requests across Pending + Ledger (all time)
            const total = new Set([...mineP, ...mineL].map(reqKey)).size;

            // Update tiles
            animateNumber($('#kpiSkus'),    KPI_PREV.activeSkus, open);
            animateNumber($('#kpiOnhand'),  KPI_PREV.onhand,     approved30);
            animateNumber($('#kpiPending'), KPI_PREV.pending,    declined30);
            animateNumber($('#kpiLedger'),  KPI_PREV.ledger,     total);

            // Keep prevs in sync
            KPI_PREV.activeSkus = open;
            KPI_PREV.onhand     = approved30;
            KPI_PREV.pending    = declined30;
            KPI_PREV.ledger     = total;

            // Persist for other views that use BOOT
            BOOT.minePending = mineP;
            BOOT.mineLedger  = mineL;
          } else {
            setMsg('Preparing dashboard…');
            renderCounts(payload.counts);
          }

          setMsg('Rendering stock…');    renderItems(payload.items);
          setMsg('Loading approvals…');  renderPending(payload.pending); renderUsersPending(payload.usersPending || []);
          setMsg('Building ledger…');    renderLedger(payload.ledger);
          setMsg('Final touches…');      fillSkuDatalist(payload.items);

          fillRequestDatalist(payload.items);
          wireRequestAutofill();
          fillItemNameDatalist(payload.items);

          // Initialize UoM selects
          populateUomSelect(document.getElementById('csUom'), '');
          populateUomSelect(document.getElementById('msUom'), '');

          // lookups, filters, wiring...
          populateBusinessUnitSelect(payload.businessUnits        || payload.lookups?.businessUnits        || []);
          populateDepartmentSelect  (payload.departments          || payload.lookups?.departments          || []);
          populateDeployLocationSelect(payload.deploymentLocations || payload.lookups?.deploymentLocations || []);
          populateCategorySelects(payload.categories || payload.lookups?.categories || []);

          populateStockFilters(payload.items);
          populatePendingFilters(payload.pending);
          populateLedgerFilters(payload.ledger);
          fillRetireDatalist(payload.items);

          wireSearch();
          wireSkuAutofill();
          fillItemNameDatalist(payload.items);
          wireDownloads();
          setupReveals();
          enableRipples();


          if (!silent) { requestAnimationFrame(() => setTimeout(() => { try { Loader.hide(); } catch(e) {} }, 120)); }
        })
        .withFailureHandler(err => {
          if (!silent) { try { Loader.hide(); } catch (e) {} }
          toast('getBootstrap failed: ' + err.message + ' — Tip: Run setup() or use Tools → Connect DB.','danger');
          showLogin();
        })
        .getBootstrap();
    }

    function showLogin(panelId, allowCreate=false){
      $('#loginScreen').style.display = 'block';
      $('#appScreen').style.display = 'none';
      if (panelId) $('#'+panelId).classList.remove('d-none');
      if (allowCreate) $('#createAccountWrap').classList.remove('d-none');
    }

    // Create Account (now with requested role)
    $('#btnCreateAccount').addEventListener('click', () => {
      const name = $('#caName').value.trim();
      const dept = $('#caDept').value.trim();
      const role = $('#caRole').value;
      if (!name) return toast('Please enter your name.');

      const btn = $('#btnCreateAccount');
      setLoading(btn, true, 'Submitting...');

      google.script.run
        .withSuccessHandler(res => {
          setLoading(btn, false);
          toast(res.message || 'Submitted');
          loadApp({ silent: true });
        })
        .withFailureHandler(e => {
          setLoading(btn, false);
          toast(e.message, 'danger');
        })
        .requestAccount(name, dept, role);
    });

    // ---- Tools menu (controller) ----
    $('#actConnect').addEventListener('click', ()=>{
      const id = prompt('Paste Spreadsheet ID (from its URL):');
      if (!id) return;
      google.script.run.withSuccessHandler(info => { toast('Connected to: ' + info.name); loadApp({silent:true}); })
        .withFailureHandler(e => toast(e.message)).connectToSpreadsheet(id.trim());
    });
    $('#actSeed').addEventListener('click', ()=>{
      google.script.run.withSuccessHandler(()=>{ toast('Test data inserted'); loadApp({silent:true}); })
        .withFailureHandler(e => toast(e.message)).seedTestData();
    });
    $('#actReload').addEventListener('click', ()=> loadApp({silent:true}));

    // ---- Renderers ----
    function renderCounts(c){
      const elSkus   = document.getElementById('kpiSkus');
      const elOnhand = document.getElementById('kpiOnhand');
      const elPend   = document.getElementById('kpiPending');
      const elLedg   = document.getElementById('kpiLedger');

      animateNumber(elSkus,   KPI_PREV.activeSkus, c.activeSkus);
      animateNumber(elOnhand, KPI_PREV.onhand,     c.onhand);
      animateNumber(elPend,   KPI_PREV.pending,    c.pending);
      animateNumber(elLedg,   KPI_PREV.ledger,     c.ledger);

      KPI_PREV.activeSkus = c.activeSkus; KPI_PREV.onhand = c.onhand; KPI_PREV.pending = c.pending; KPI_PREV.ledger = c.ledger;
    }

    function fillSkuDatalist(items){
      const dl=$('#skuList'); dl.innerHTML='';
      (items||[]).forEach(it=>{ const o=document.createElement('option'); o.value=it.SKU; o.label=`${it.Name} — ${it.Description||''}`; dl.appendChild(o); });
    }
    function fillItemNameDatalist(items){
      const dl = $('#itemListAll'); if (!dl) return;
      dl.innerHTML = '';
      (items || []).forEach(it => {
        const o = document.createElement('option');
        // Show "Name — SKU" so we can parse the SKU reliably
        o.value = `${it.Name} — ${it.SKU}`;
        dl.appendChild(o);
      });
    }
    function fillRetireDatalist(items){
      const dl = $('#skuListRetire'); if (!dl) return;
      dl.innerHTML = '';
      (items||[])
        .filter(it => Number(it.Qty || 0) === 0 && (String(it.Status) === 'Active' || String(it.Status) === 'On Hold'))
        .forEach(it => {  
          const o = document.createElement('option');
          o.value = it.SKU;
          o.label = `${it.Name} — ${it.Description || ''} (0 ${it.UoM || ''})`;
          dl.appendChild(o);
        });
    }

    function renderItems(items){
      const q = ($('#stockSearch').value||'').toLowerCase();
      const tb = $('#tblStock tbody'); tb.innerHTML='';

      const fStatus = $('#stockFilterStatus')?.value || '';
      const fCat    = $('#stockFilterCat')?.value || '';
      const fUom    = $('#stockFilterUom')?.value || '';

      const filtered = (items||[]).filter(it => {
        const hay = `${it.SKU} ${it.Name} ${it.Description} ${it.Category||''} ${it.Status}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (fStatus && String(it.Status) !== fStatus) return false;
        if (fCat && String(it.Category || '') !== fCat) return false;
        if (fUom && String(it.UoM) !== fUom) return false;
        return true;
      });


      LAST.stock = filtered;

      const pg = getPage(filtered, PAGE.stock, PAGE_SIZE);
      PAGE.stock = pg.page;

      pg.rows.forEach(it=>{
        const frag = document.importNode($('#tplStockRow').content, true);
        const row  = frag.querySelector('tr');
        row.classList.add('anim-row');

        const skuEl = frag.querySelector('.sku-link');
        skuEl.textContent = it.SKU;
        skuEl.addEventListener('click', ()=> openSkuHistory(it.SKU));

        const nameEl = frag.querySelector('.item-name');
        nameEl.textContent = it.Name;

        // NEW: description cell (prefer ItemDescription alias from backend)
        frag.querySelector('.desc').textContent = it.ItemDescription || it.Description || '';

        frag.querySelector('.uom').textContent = it.UoM || '';
        frag.querySelector('.price').textContent = money(computeDisplayUnitPrice(it));
        frag.querySelector('.qty').textContent = fmt(it.Qty || 0);
        frag.querySelector('.cat').textContent = it.Category || '';
        const statusHtml = it.Status === 'Active'
          ? '<span class="badge text-bg-success">Active</span>'
          : (it.Status === 'On Hold'
              ? '<span class="badge text-bg-warning text-dark">On Hold</span>'
              : '<span class="badge text-bg-secondary">Retired</span>');
        frag.querySelector('.status').innerHTML = statusHtml;

        frag.querySelector('.btn-view').addEventListener('click', ()=> openItemDetails(it));

        if (window.IS_USER) {
          // Hide edit/retire for Users
          frag.querySelector('.btn-edit')?.remove();
          frag.querySelector('.btn-retire')?.remove();
        } else {
          frag.querySelector('.btn-edit').addEventListener('click', ()=>{
            $('#msSku').value = it.SKU;
            $('#msName').value = it.Name;
            $('#msDesc').value = it.Description || '';
            $('#msUom').value  = it.UoM || '';
            $('#msLoc').value  = it.Location || '';
            $('#msStatus').value = it.Status || 'Active';
            $('#msPrice').value = computeDisplayUnitPrice(it) ?? '';

            // Category (ensure options exist)
            const catSel = document.getElementById('msCategory');
            if (catSel && catSel.options.length <= 1) {
              populateCategorySelects(BOOT?.categories || BOOT?.lookups?.categories || []);
            }
            if (catSel) catSel.value = it.Category || '';

            const btnPH = document.getElementById('btnOpenPriceHistory');
            if (btnPH){
              btnPH.onclick = () => openPriceHistory(it.SKU);
            }
          });


          const btnRet = frag.querySelector('.btn-retire');
          btnRet.disabled = (Number(it.Qty) > 0) || it.Status !== 'Active';
          btnRet.addEventListener('click', ()=>{
            $('#rsSku').value = it.SKU;
            bootstrap.Modal.getOrCreateInstance('#modalRetireSku').show();
          });
        }

        tb.appendChild(frag);
        requestAnimationFrame(()=> row.classList.add('show'));
      });

      renderPager('stock', 'pagerStock', pg);
    }

    function typeBadge(t){
      const map = { CREATE_SKU:['success','Create SKU'], MODIFY_SKU:['info','Modify'], RETIRE_SKU:['secondary','Retire'], REACTIVATE_SKU:['primary','Reactivate'], RECEIVE:['success','Receive'], ISSUE:['warning','Issue'] };
      const [c,txt] = map[t] || ['light',t]; return `<span class="badge text-bg-${c}">${txt}</span>`;
    }
    function statusBadge(s){
      const map = { Pending:['secondary','Pending'], Approved:['success','Approved'], Declined:['danger','Declined'], Voided:['dark','Voided'] };
      const [c,txt] = map[s] || ['light',s]; return `<span class="badge text-bg-${c}">${txt}</span>`;
    }
    function qtyBadge(n){
      if (n === '' || n === null || n === undefined) return '<span class="badge text-bg-light">—</span>';
      const val = Number(n);
      if (Number.isNaN(val)) return '<span class="badge text-bg-light">—</span>';
      const cls = val > 0 ? 'success' : (val < 0 ? 'warning' : 'secondary');
      const txt = (val > 0 ? '+' : '') + val;
      return `<span class="badge text-bg-${cls}">${txt}</span>`;
    }

    function renderPending(list){
      const q = ($('#pendingSearch').value||'').toLowerCase();
      const tb = $('#tblPending tbody'); tb.innerHTML='';

      const fType     = $('#pendFilterType')?.value || '';
      const fBy       = $('#pendFilterBy')?.value || '';
      const fApprover = $('#pendFilterApprover')?.value || '';

      const filtered = (list||[]).filter(p => {
        const hay = `${p.Type} ${p.SKU||''} ${p.Name||''} ${p.By||''} ${p.CurrentApprover||''}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (fType && p.Type !== fType) return false;
        if (fBy   && p.By   !== fBy)   return false;
        if (fApprover && String(p.CurrentApproverRole||'').toLowerCase() !== fApprover) return false;
        return true;
      });
      LAST.pending = filtered;

      const pg = getPage(filtered, PAGE.pending, PAGE_SIZE);
      PAGE.pending = pg.page;

      pg.rows.forEach(p=>{
        const frag = document.importNode($('#tplPendingRow').content, true);
        const row  = frag.querySelector('tr');
        row.classList.add('anim-row');

        frag.querySelector('.when').textContent    = when(p.When);
        frag.querySelector('.type').innerHTML      = typeBadge(p.Type);
        frag.querySelector('.sku').innerHTML       = formatSkuChips(p.SKU);
        frag.querySelector('.details').innerHTML   = buildDetailsHTML(p);
        frag.querySelector('.by').textContent      = p.By || '';
        frag.querySelector('.approver').textContent = p.CurrentApprover || '—';

        const btnApprove = frag.querySelector('.btn-approve');
        const btnDecline = frag.querySelector('.btn-decline');
        const btnVoid    = frag.querySelector('.btn-void');

        btnApprove.addEventListener('click', ()=> openApproveConfirm(btnApprove, p));
        btnDecline.addEventListener('click', ()=> openActionConfirm(btnDecline, p.PendingID, p, 'decline'));
        btnVoid   ?.addEventListener('click', ()=> openActionConfirm(btnVoid,    p.PendingID, p, 'void'));

        tb.appendChild(frag);
        requestAnimationFrame(()=> row.classList.add('show'));
      });

      renderPager('pending', 'pagerPending', pg);
    }



    let confirmCtx = null; // { btn, id, rec, action: 'decline'|'void' }

    function handleApprove(btn, id){
      setLoading(btn, true, 'Approving...');
      google.script.run
        .withSuccessHandler(()=>{
          setLoading(btn,false);
          toast('Approved','success');
          loadApp({silent:true});
        })
        .withFailureHandler(e=>{
          setLoading(btn,false);
          toast(e.message,'danger');
        })
        .approvePending(id);
    }

    function openActionConfirm(btn, id, rec, action){
      confirmCtx = { btn, id, rec, action };
      const noun = action === 'void' ? 'Void' : 'Decline';

      // 1) Mirror the Approve summary inside the Decline modal
      const summaryEl = document.getElementById('confirmMessage');
      if (summaryEl) summaryEl.innerHTML = buildApproveSummaryHTML(rec);

      // 2) Reset/focus reason
      const reasonEl = document.getElementById('confirmReason');
      if (reasonEl) reasonEl.value = '';

      // 3) Header + primary button state/text
      const titleEl = document.querySelector('#modalConfirm .modal-title');
      if (titleEl){
        titleEl.innerHTML = `<i class="fa-solid fa-circle-question me-2"></i>Confirm Action — ${noun}`;
      }
      const yes = document.getElementById('confirmYes');
      if (yes){
        if (action === 'void'){
          // neutral, no aggressive color for user cancel
          yes.className = 'btn btn-light-alt';
          yes.innerHTML = `<i class="fa-solid fa-check me-1"></i>Confirm Cancel`;
        } else {
          yes.className = 'btn btn-danger';
          yes.innerHTML = `<i class="fa-solid fa-xmark me-1"></i>Confirm Decline`;
        }
      }

      // 4) Show modal
      const m = bootstrap.Modal.getOrCreateInstance('#modalConfirm');
      m.show();
      setTimeout(()=> reasonEl?.focus(), 200);
    }


    document.getElementById('confirmYes').addEventListener('click', ()=>{
      const ctx = confirmCtx; if (!ctx) return;

      const reason = (document.getElementById('confirmReason')?.value || '').trim();
      if (!reason) { toast('Reason is required.','danger'); document.getElementById('confirmReason')?.focus(); return; }

      const modalEl = document.getElementById('modalConfirm');
      const inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      inst.hide();

      const verb = ctx.action === 'void' ? 'Voiding...' : 'Declining...';
      setLoading(ctx.btn, true, verb);

      const done = (okMsg)=>{
        setLoading(ctx.btn,false);
        toast(okMsg,'warning');
        loadApp({silent:true});
      };
      const fail = (e)=>{
        setLoading(ctx.btn,false);
        toast(e.message,'danger');
      };

      if (ctx.action === 'void'){
        google.script.run.withSuccessHandler(()=> done('Voided')).withFailureHandler(fail).voidPending(ctx.id, reason);
      } else {
        google.script.run.withSuccessHandler(()=> done('Declined')).withFailureHandler(fail).declinePending(ctx.id, reason);
      }
    });


  function renderUsersPending(users){
    const tb = document.querySelector('#tblUsersPending tbody');
    if (!tb) return;
    tb.innerHTML = '';

    (users || []).forEach(u => {
      const requested = u.RequestedRole || 'user';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${when(u.CreatedAt)}</td>
        <td>${u.Name || ''}</td>
        <td>${u.Email || ''}</td>
        <td>${u.Department || ''}</td>
        <td>${friendlyRole(requested)}</td>
        <td>
          <select class="form-select form-select-sm roleSel">
            <option value="user"${requested==='user' ? ' selected' : ''}>User (Requester)</option>
            <option value="manager"${requested==='manager' ? ' selected' : ''}>Inventory Manager</option>
            <option value="controller"${requested==='controller' ? ' selected' : ''}>Controller</option>
          </select>
        </td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-success btn-approve-user" title="Approve">
              <i class="fa-solid fa-check"></i>
            </button>
            <button class="btn btn-danger btn-disable-user" title="Disable">
              <i class="fa-solid fa-user-slash"></i>
            </button>
          </div>
        </td>
      `;

      const roleSel    = tr.querySelector('.roleSel');
      const approveBtn = tr.querySelector('.btn-approve-user');
      const disableBtn = tr.querySelector('.btn-disable-user');

      approveBtn.addEventListener('click', () => {
        openUserConfirm(approveBtn, u, roleSel.value, 'approve');
      });
      disableBtn.addEventListener('click', () => {
        openUserConfirm(disableBtn, u, roleSel.value, 'disable');
      });

      tb.appendChild(tr);
    });
  }

  // Merge all note sources (primary Note, Approve/Action comment fields, and payload.approval.comment)
  function mergedNote(rec, extraLine){
    const primary = String(rec?.Note || '').trim();
    const base = primary ? primary.split(/\n+/) : [];

    const isItemLine = l => /^\s*\d+?\.\s*.+\([^)]+\)\s*$/i.test(String(l||''));
    const keyItem = l => String(l).replace(/^\s*\d+?\.\s*/, '').replace(/\s+/g,' ').trim().toLowerCase();

    const out = [...base];

    // Optional extra single line (e.g., parsed per-item from a multi-row)
    if (extraLine && String(extraLine).trim()){
      const s = String(extraLine).trim();
      if (isItemLine(s)) {
        const k = keyItem(s);
        if (!out.some(x => isItemLine(x) && keyItem(x) === k)) out.push(s);
      } else if (!primary.toLowerCase().includes(s.toLowerCase())) {
        out.push(s);
      }
    }

    // Common server-sent comment fields to fold in
    [
      rec?.ApproveComment, rec?.ApproverComment, rec?.ApproverNote,
      rec?.ActionNote,     rec?.ReviewNote
    ].forEach(v=>{
      const s = String(v||'').trim();
      if (!s) return;
      if (!primary.toLowerCase().includes(s.toLowerCase())) out.push(s);
    });

    // Final de-dup (item lines by key; others by lower text)
    const seen = new Set();
    const final = [];
    out.forEach(line=>{
      const key = (isItemLine(line) ? 'item:' + keyItem(line) : 'txt:' + String(line).toLowerCase());
      if (seen.has(key)) return;
      seen.add(key);
      final.push(line);
    });
    return final.join('\n');
  }

  function _namesFromSkus(skuList){
    if (!Array.isArray(skuList) || !skuList.length) return [];
    const bySku = (typeof BOOT === 'object' && Array.isArray(BOOT?.items))
      ? new Map(BOOT.items.map(x => [String(x.SKU), x.Name || '']))
      : new Map();
    return skuList.map(s => {
      const sku = String(s).trim();
      const name = bySku.get(sku) || '';
      return { qty: null, uom: '', name, sku };
    }).filter(it => it.sku); // keep only valid SKU entries
  }


  // 2) Robust item extractor (PayloadJSON → Note lines → single)
  function _itemsFromRow(row){
    // Prefer structured payload first
    try{
      const p = row && row.PayloadJSON ? JSON.parse(row.PayloadJSON) : null;
      if (p && Array.isArray(p.items) && p.items.length){
        // CREATE: often only SKUs (no qty/uom)
        if (row?.Type === 'CREATE_SKU') {
          let items = p.items.map(it => ({
            qty: null,
            uom: '',
            name: it.Name ?? it.name ?? '',
            sku:  it.SKU  ?? it.sku  ?? ''
          }));

          // If names are missing, fill via BOOT.items lookup
          const haveAnyName = items.some(it => (it.name || '').trim());
          if (!haveAnyName) {
            const skus = items.map(it => it.sku).filter(Boolean);
            const looked = _namesFromSkus(skus);
            if (looked.length) return looked;
          }
          return items;
        }

        // Other actions
        return p.items.map(it => ({
          qty: it.qty ?? it.Qty ?? row.Delta ?? row.Qty ?? '',
          uom: it.UoM ?? it.uom ?? row.UoM ?? '',
          name: it.Name ?? it.name ?? row.Item ?? row.Name ?? '',
          sku:  it.SKU  ?? it.sku  ?? row.SKU  ?? ''
        }));
      }
    }catch(_){}

    // ==== CREATE fallback (no/empty PayloadJSON.items) ====
    if (row?.Type === 'CREATE_SKU') {
      const skus = new Set();

      // A) row.SKU as CSV (e.g., "YDC-PROC-0059, YDC-PROC-0060")
      if (row?.SKU) {
        String(row.SKU).split(/\s*,\s*/).forEach(s => { if (s) skus.add(s); });
      }

      // B) From Note summary: "Create SKU — 2 item(s) (YDC-..., YDC-...)"
      if (row?.Note) {
        const m = String(row.Note).match(/create\s*sku.*\(([^)]+)\)/i);
        if (m && m[1]) {
          m[1].split(/\s*,\s*/).forEach(s => { if (s) skus.add(s.trim()); });
        }
      }

      // C) Last resort: parse full note for parenthetical SKU-like tokens
      if (!skus.size && row?.Note) {
        const paren = String(row.Note).match(/\(([^)]+)\)/);
        if (paren && paren[1]) {
          paren[1].split(/\s*,\s*/).forEach(s => { if (s) skus.add(s.trim()); });
        }
      }

      const items = _namesFromSkus([...skus]);
      if (items.length) return items;
      // If still nothing, fall through to generic fallbacks
    }

    // Generic parser from Note lines like "3 pcs — Name (SKU)"
    const parseLine = (line)=>{
      const s = String(line||'').trim();
      if (/^create\s+sku\b/i.test(s)) return null; // ignore CREATE summary lines
      const re = /^\s*(?:\d+\.\s*)?(-?\d+(?:\.\d+)?)\s+(.+?)\s*[—–-]\s*(.+?)\s*\(\s*([^)]+)\s*\)\s*$/;
      const m = s.match(re);
      if(!m) return null;
      return { qty: m[1], uom: m[2], name: m[3], sku: m[4] };
    };
    const fromNote = String(row?.Note||'').split(/\n+/).map(parseLine).filter(Boolean);
    if (fromNote.length) return fromNote;

    // Single-record fallback
    if (row && (row.SKU || row.Name || row.Item)) {
      return [{
        qty: row.Delta ?? row.Qty ?? '',
        uom: row.UoM ?? '',
        name: row.Item || row.Name || '',
        sku:  row.SKU  || ''
      }];
    }
    return [];
  }


  // 3) Item-cell HTML (uniform like Receive)
  function buildLedgerItemCell(row){
    const items = _itemsFromRow(row);

    const friendly = (()=>{
      const m = { CREATE_SKU:'Create SKU', MODIFY_SKU:'Modify Item', RETIRE_SKU:'Retire SKU', RECEIVE:'Receive (Inbound)', ISSUE:'Issue (Outbound)' };
      return m[row?.Type] || String(row?.Type||'');
    })();

    // Title: prefer row.Item; else "<Type> — N item(s)"
    const title = row?.Item && !/^Batch of \d+ items$/i.test(String(row.Item))
      ? row.Item
      : `${friendly}${items.length ? ` — ${items.length} item(s)` : ''}`;

    // Names for the gray subline
    let names = [...new Set(
      items.map(it => (it.name || '').trim()).filter(Boolean)
    )];

    // ✅ Only for CREATE, drop accidental "Create SKU — ..." as a name and de-dupe with title
    if (row?.Type === 'CREATE_SKU') {
      names = names
        .filter(n => !/^create\s+sku\b/i.test(n))
        .filter(n => n.toLowerCase() !== String(title).toLowerCase());
    }

    const below = names.length ? `<div class="small text-secondary">${names.join(', ')}</div>` : '';
    return `<div>${title || '—'}</div>${below}`;
  }



  // 4) Note-cell HTML (ordered item lines + gray meta), consistent for all actions
  function buildLedgerNoteCell(row){
    const items = _itemsFromRow(row);

    // CREATE_SKU: list as "Name (SKU)" (no qty/uom), ignore summary lines
    if (row?.Type === 'CREATE_SKU') {
      const lines = items
        .map(it => {
          const name = (it.name || '').trim();
          const sku  = (it.sku  || '').trim();
          if (!name && !sku) return null;
          return `${name || '—'}${sku ? ` (${sku})` : ''}`;
        })
        .filter(Boolean);

      // Pull non-item meta from merged notes, skipping summary lines
      const meta = String(mergedNote(row) || '')
        .split(/\n+/)
        .filter(l => l && !/^create\s+sku\b/i.test(l));

      let html = '';
      if (lines.length){
        html += `<ol class="mb-1">${lines.map(l => `<li>${l}</li>`).join('')}</ol>`;
      }
      if (meta.length){
        html += `<div class="small text-secondary">${meta.join(' · ')}</div>`;
      }
      return html || '—';
    }

    // ---- default path (Receive/Issue/etc.): keep your existing behavior ----
    const itemLines = items.map(it => {
      const qty = (it.qty === '' || it.qty === null || it.qty === undefined) ? '—' : it.qty;
      const uom = it.uom || '';
      const nm  = it.name || '—';
      const sk  = it.sku  || '—';
      return `${qty} ${uom} — ${nm} (${sk})`;
    });

    const txt = String(mergedNote(row) || '').trim();
    const rawLines = txt ? txt.split(/\n+/) : [];
    const isItemLine = (l)=> /^\s*\d+?\.\s*.+\([^)]+\)\s*$/i.test(l) || /^\s*-?\d+(?:\.\d+)?\s+.+—.+\([^)]+\)\s*$/i.test(l);
    const itemKey = (l)=> String(l).replace(/^\s*\d+?\.\s*/, '').replace(/\s+/g,' ').trim().toLowerCase();

    const keepOther = [];
    const seenItem = new Set(itemLines.map(itemKey));
    for (const l of rawLines){
      if (/^create\s+sku\b/i.test(l)) continue;  // never treat summary as item/meta elsewhere
      if (isItemLine(l)) {
        const k = itemKey(l);
        if (!seenItem.has(k)) itemLines.push(l.replace(/^\s*\d+?\.\s*/, ''));
        continue;
      }
      keepOther.push(l);
    }

    let html = '';
    if (itemLines.length){
      html += `<ol class="mb-1">${itemLines.map(l => `<li>${l.replace(/^\s*\d+?\.\s*/, '')}</li>`).join('')}</ol>`;
    }
    if (keepOther.length){
      html += `<div class="small text-secondary">${keepOther.join(' · ')}</div>`;
    }
    return html || '—';
  }


  function renderLedger(list){
    // If requestor, restrict ledger to their own ISSUE requests
    // Prefer BOOT.user.role (available on first load); fall back to IS_USER flag.
    var isUser = ((BOOT && BOOT.user && BOOT.user.role === 'user') || IS_USER === true);
    if (isUser && BOOT && BOOT.user && BOOT.user.email) {
      var myEmail = String(BOOT.user.email || '').toLowerCase();
      list = (list || []).filter(function(l){
        return String(l.By || '').toLowerCase() === myEmail && String(l.Type) === 'ISSUE';
      });
    }

    var q = ($('#ledgerSearch').value || '').toLowerCase();
    var tb = $('#tblLedger tbody'); tb.innerHTML = '';

    var fType   = $('#ledgerFilterType') ? $('#ledgerFilterType').value : '';
    var fStatus = $('#ledgerFilterStatus') ? $('#ledgerFilterStatus').value : '';
    var dFromV  = $('#ledgerFrom') ? $('#ledgerFrom').value : '';
    var dToV    = $('#ledgerTo') ? $('#ledgerTo').value : '';
    var dFrom   = dFromV ? new Date(dFromV + 'T00:00:00') : null;
    var dTo     = dToV   ? new Date(dToV   + 'T23:59:59') : null;

    var filtered = (list || []).filter(function(l){
      var hay = (l.ID + ' ' + l.Type + ' ' + (l.SKU||'') + ' ' + (l.Item||'') + ' ' + l.Status + ' ' + (l.By||'') + ' ' + (l.Note||'')).toLowerCase();
      if (q && hay.indexOf(q) === -1) return false;
      if (fType   && l.Type   !== fType)   return false;
      if (fStatus && l.Status !== fStatus) return false;
      if (dFrom && new Date(l.When) < dFrom) return false;
      if (dTo   && new Date(l.When) > dTo)   return false;
      return true;
    }).reverse();
    LAST.ledger = filtered;

    var pg = getPage(filtered, PAGE.ledger, PAGE_SIZE);
    PAGE.ledger = pg.page;

    pg.rows.forEach(function(l){
      var frag = document.importNode($('#tplLedgerRow').content, true);
      var row  = frag.querySelector('tr');
      row.classList.add('anim-row');

      frag.querySelector('.id').textContent     = l.ID;
      frag.querySelector('.when').textContent   = when(l.When);
      frag.querySelector('.type').innerHTML     = typeBadge(l.Type);
      frag.querySelector('.sku').innerHTML      = formatSkuChips(l.SKU);
      // 🔁 Uniform cells for ALL actions (copying Receive format)
      frag.querySelector('.name').innerHTML     = buildLedgerItemCell(l);
      frag.querySelector('.delta').innerHTML    = qtyBadge(l.Delta);
      frag.querySelector('.uom').textContent    = l.UoM || '';
      frag.querySelector('.status').innerHTML   = statusBadge(l.Status);
      frag.querySelector('.by').textContent     = l.By || '';
      frag.querySelector('.note').innerHTML     = buildLedgerNoteCell(l);

      tb.appendChild(frag);
      requestAnimationFrame(function(){ row.classList.add('show'); });
    });

    renderPager('ledger', 'pagerLedger', pg);
  }

    let IS_USER = false;

    function buildSummaryTable(rows){
      return `
        <table class="table table-sm align-middle mb-0">
          <tbody>
            ${rows.map(([k,v])=>`
              <tr>
                <th class="text-secondary" style="width:180px">${k}</th>
                <td>${v ?? '—'}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }

    function openMyReqDetails(rec){
      const roleNice = (r) => {
        const v = String(r || '').toLowerCase();
        if (v === 'manager')    return 'Managers';
        if (v === 'controller') return 'Controllers';
        return r || '—';
      };
      const currApprover = (rec.Status === 'Pending') ? roleNice(rec.NextRole) : '—';

      // Build a compact bullet list of all requested items
      const listHtml = (Array.isArray(rec.Items) && rec.Items.length)
        ? `<ul class="mb-0">${rec.Items.map(it => `
            <li>${(it.qty ?? '—')} ${it.uom || ''} — ${it.name || '—'} <span class="text-secondary">(${it.sku || '—'})</span></li>
          `).join('')}</ul>`
        : (rec.Item || rec.Name || '—');

      // Optional: SKU list (CSV) if multiple
      const skuCsv = (Array.isArray(rec.Items) && rec.Items.length)
        ? rec.Items.map(it => it.sku).filter(Boolean).join(', ')
        : (rec.SKU || '');

      const rows = [
        ['Status', rec.Status || '—'],
        ['Current Approver', currApprover],
        ['When', when(rec.When)],
        ['SKU(s)', skuCsv || '—'],
        ['Item(s)', listHtml],
        ['Note', rec.Note || '—'],
        ['Reason', rec.Reason || '—'],
        ['Record ID', rec.RecordID || rec.ID || '—']
      ];

      // Allow HTML for the Item(s) cell
      const htmlTable = `
        <table class="table table-sm align-middle mb-0">
          <tbody>
            ${rows.map(([k,v])=>`
              <tr>
                <th class="text-secondary" style="width:180px">${k}</th>
                <td>${v ?? '—'}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;

      $('#myReqSummary').innerHTML = htmlTable;
      bootstrap.Modal.getOrCreateInstance('#modalMyReq').show();
    }

    // === Requester edit/cancel helpers ===
    function isPendingRow(rec){ return String(rec.Status) === 'Pending'; }
    function pendingIdOf(rec){ return rec.RecordID || rec.PendingID || rec.recid || rec.ID || ''; }

    let MY_EDIT_CTX = { pendingId: '', model: null };
    const EDIT_CART = new Map(); // sku -> { sku, name, desc, uom, onhand, qty }

    function edRenderCart(){
      const tb   = document.getElementById('edCartBody');
      const meta = document.getElementById('edCartMeta');
      if (!tb || !meta) return;

      tb.innerHTML = '';
      const items = Array.from(EDIT_CART.values());
      if (!items.length){
        meta.textContent = 'No items selected.';
        return;
      }
      meta.textContent = `${items.length} item(s) selected.`;

      items.forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.sku}</td>
          <td>${it.name || ''}</td>
          <td>${it.desc || ''}</td>
          <td>${it.uom  || ''}</td>
          <td class="text-end">${fmt(it.onhand ?? 0)}</td>
          <td class="text-end">
            <div class="input-group input-group-sm">
              <input type="number" min="1" step="1" class="form-control text-end qty-inp" value="${Number(it.qty||1)}">
            </div>
          </td>
          <td class="text-end">
            <button class="btn btn-outline-danger btn-sm rm" type="button"><i class="fa-solid fa-trash-can"></i></button>
          </td>
        `;
        tr.querySelector('.qty-inp').addEventListener('input', (e)=>{
          let v = parseInt(e.target.value, 10);
          if (isNaN(v) || v < 1) v = 1;
          e.target.value = v;
          const cur = EDIT_CART.get(it.sku);
          if (cur){ cur.qty = v; }
        });
        tr.querySelector('.rm').addEventListener('click', ()=>{
          EDIT_CART.delete(it.sku);
          edRenderCart();
        });
        tb.appendChild(tr);
      });
    }

    /* Open Edit modal for a given PendingID */
    function openEditMyReq(pendingId){
      MY_EDIT_CTX = { pendingId, model: null };
      EDIT_CART.clear();
      edRenderCart();
      document.getElementById('edReason').value = '';

      bootstrap.Modal.getOrCreateInstance('#modalEditMyReq').show();

      // Load current request to seed cart + reason
      google.script.run
        .withSuccessHandler(res => {
          const mdl = res?.model || {};
          MY_EDIT_CTX.model = mdl;
          document.getElementById('edReason').value = mdl.reason || '';

          const items = Array.isArray(mdl.items) ? mdl.items : [];
          items.forEach(line => {
            const sku = line.SKU || line.sku;
            if (!sku) return;
            const it  = lookupSku(sku) || {};
            EDIT_CART.set(sku, {
              sku,
              name: it.Name || line.Name || line.name || '',
              desc: it.Description || it.ItemDescription || '',
              uom:  it.UoM || line.UoM || line.uom || '',
              onhand: it.Qty ?? 0,
              qty: Math.max(1, parseInt(line.qty || line.Qty || 1, 10))
            });
          });
          edRenderCart();
        })
        .withFailureHandler(e => {
          toast({ title:'Load failed', message: (e?.message || String(e)), type:'danger' });
        })
        .getPendingForEdit(pendingId);
    }

    /* Submit edited request */
    document.getElementById('formEditRequest')?.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const btn = document.getElementById('edSubmitBtn');
      const reason = document.getElementById('edReason')?.value.trim() || '';
      const items  = Array.from(EDIT_CART.values()).map(it => ({
        SKU: it.sku, Name: it.name, UoM: it.uom, qty: Number(it.qty||1)
      }));

      if (!items.length){
        toast({ message:'Nothing to submit. Remove/adjust items only; adding new items isn’t available here.', type:'warning' });
        return;
      }

      setLoading(btn, true, 'Saving…');
      google.script.run
        .withSuccessHandler(res => {
          setLoading(btn, false);
          bootstrap.Modal.getInstance(document.getElementById('modalEditMyReq'))?.hide();
          toast({ title:'Edited & Resubmitted', message:`Pending ID: ${res?.pendingId || ''}`, type:'success' });
          loadApp({ silent:true });
        })
        .withFailureHandler(e => {
          setLoading(btn, false);
          toast({ title:'Save failed', message:(e?.message || String(e)), type:'danger' });
        })
        .submitEditPending(MY_EDIT_CTX.pendingId, { reason, items });
    });

    function openCancelMyReq(pendingId){
      const reasonEl = document.getElementById('myCancelReason');
      if (reasonEl) reasonEl.value = ''; // no default text

      document.getElementById('myCancelGo').onclick = function(){
        const btn = this;
        const why = (reasonEl?.value || '').trim(); // optional

        setLoading(btn, true, 'Cancelling…');
        google.script.run
          .withSuccessHandler(()=>{
            setLoading(btn, false);
            bootstrap.Modal.getInstance(document.getElementById('modalCancelMyReq'))?.hide();
            toast({ title:'Cancelled', message:'Your request has been cancelled.', type:'warning' });
            loadApp({ silent:true });
          })
          .withFailureHandler(e=>{
            setLoading(btn, false);
            toast({ title:'Cancel failed', message:(e?.message || String(e)), type:'danger' });
          })
          .cancelMyPending(pendingId, why);
      };

      bootstrap.Modal.getOrCreateInstance('#modalCancelMyReq').show();
    }

    function renderMine(minePending){
      // Only show ISSUE requests from the Pending sheet
      const rows = (minePending || [])
      .filter(p => p.Type === 'ISSUE')
      .map(p => {
        const items = extractItemsFromPayload(p);
        let itemLabel = '';
        if (items && items.length) {
          const first = items[0] || {};
          const firstName = (first.name || '').trim();
          const firstSku  = (first.sku  || '').trim();
          if (items.length === 1) {
            itemLabel = firstName || firstSku || (p.Name || '') || (p.SKU || '');
          } else {
            const head = firstName || firstSku || 'Item';
            itemLabel = `${head} + ${items.length - 1} more`;
          }
        } else {
          itemLabel = (p.Name || '').trim() || (p.SKU || '').trim();
          if (!itemLabel) {
            const countFromCsv = String(p.SKU || '').split(',').map(s => s.trim()).filter(Boolean).length;
            if (countFromCsv > 1) itemLabel = `Batch of ${countFromCsv} items`;
          }
          if (!itemLabel) itemLabel = 'Batch of items';
        }

        return {
          When: p.When,
          Status: p.Status,
          SKU: p.SKU,
          Item: itemLabel,
          Items: items,
          Qty: (p.Qty !== '' && p.Qty != null) ? p.Qty : p.Delta,
          UoM: p.UoM,
          Note: p.Note,
          Reason: p.Reason,
          RecordID: p.PendingID,
          NextRole: (p.NextRole || p.nextRole || ''),
          _raw: p
        };
      })
      .sort((a,b) => new Date(b.When) - new Date(a.When));

      const q = ($('#mineSearch').value||'').toLowerCase();
      const fStatus = $('#mineFilterStatus')?.value || '';

      const filtered = rows.filter(r=>{
        const hay = `${r.SKU} ${r.Item} ${r.Status} ${r.Note||''} ${r.Reason||''}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (fStatus && r.Status !== fStatus) return false;
        return true;
      });

      LAST.mine = filtered;
      const pg = getPage(filtered, PAGE.mine, PAGE_SIZE);
      PAGE.mine = pg.page;

      const tb = $('#tblMine tbody'); tb.innerHTML = '';
      pg.rows.forEach(rec=>{
        const frag = document.importNode($('#tplMineRow').content, true);
        const row  = frag.querySelector('tr');
        row.classList.add('anim-row');

        frag.querySelector('.when').textContent   = when(rec.When);
        frag.querySelector('.status').innerHTML   = statusBadge(rec.Status);
        frag.querySelector('.sku').textContent    = rec.SKU || '';
        frag.querySelector('.name').textContent   = rec.Item || '';
        frag.querySelector('.qty').textContent    = (rec.Qty === '' || rec.Qty == null) ? '—' : fmt(rec.Qty);
        frag.querySelector('.uom').textContent    = rec.UoM || '';
        frag.querySelector('.recid').textContent  = rec.RecordID || '';

        const roleNice = r => {
          const v = String(r || '').toLowerCase();
          if (v === 'manager') return 'Managers';
          if (v === 'controller') return 'Controllers';
          return r || '—';
        };
        const curr = (rec.Status === 'Pending') ? roleNice(rec.NextRole) : '—';
        frag.querySelector('.current-approver').textContent = curr;

        // Bind actions
        frag.querySelector('.btn-view-req').addEventListener('click', ()=> openMyReqDetails(rec));

        const bEdit   = frag.querySelector('.btn-edit-req');
        const bCancel = frag.querySelector('.btn-cancel-req');

        const pid = pendingIdOf(rec) || pendingIdOf(rec._raw || {});
        const enable = isPendingRow(rec);

        if (bEdit){
          bEdit.disabled = !enable;
          bEdit.addEventListener('click', ()=> { if (enable) openEditMyReq(pid); });
        }
        if (bCancel){
          bCancel.disabled = !enable;
          bCancel.addEventListener('click', ()=> { if (enable) openCancelMyReq(pid); });
        }

        tb.appendChild(frag);
        requestAnimationFrame(()=> row.classList.add('show'));
      });

      renderPager('mine', 'pagerMine', pg);
    }


    function populateMineFilters(minePending){
      const statuses = Array.from(new Set((minePending || [])
        .filter(p => p.Type === 'ISSUE')
        .map(p => p.Status)))
        .filter(Boolean)
        .sort();

      const sel = $('#mineFilterStatus');
      if (sel) {
        const keepFirst = sel.querySelector('option[value=""]')?.outerHTML || '<option value="">All Status</option>';
        sel.innerHTML = keepFirst + statuses.map(s => `<option value="${s}">${s}</option>`).join('');
      }
    }

    // Apply role-based UI changes
    function applyUserMode(payload){
      IS_USER = (payload.user?.role === 'user');

      // KPI titles
      const t1 = $('#kpiTitle1'), t2 = $('#kpiTitle2'), t3 = $('#kpiTitle3'), t4 = $('#kpiTitle4');

      // Quick actions buttons
      const idsAdmin = ['btnOpenReceive','btnOpenIssue','btnOpenCreate','btnOpenModify','btnOpenRetire'];
      const btnReq = $('#btnOpenRequest');

      const stockWrap = document.getElementById('stockWrap');

      if (IS_USER){
        idsAdmin.forEach(id => document.getElementById(id)?.classList.add('d-none'));
        btnReq?.classList.remove('d-none');

        // Hide Stock Overview for requestors
        if (stockWrap) stockWrap.classList.add('d-none');

        if (t1) t1.textContent = 'Open Requests';
        if (t2) t2.textContent = 'Approved (30d)';
        if (t3) t3.textContent = 'Declined (30d)';
        if (t4) t4.textContent = 'Total Requested';

        // Show My Requests section
        $('#myRequestsWrap').style.display = 'block';

        // Prefer backend-provided mine*; else filter globals by signed-in user
        const myEmailLc = String(payload.user?.email || '').toLowerCase();

        const mineP = (payload.minePending && Array.isArray(payload.minePending))
          ? payload.minePending.filter(p => p.Type === 'ISSUE')
          : (payload.pending || []).filter(p =>
              p.Type === 'ISSUE' && String(p.By || '').toLowerCase() === myEmailLc
            );

        const mineL = (payload.mineLedger && Array.isArray(payload.mineLedger))
          ? payload.mineLedger.filter(l => l.Type === 'ISSUE')
          : (payload.ledger || []).filter(l =>
              l.Type === 'ISSUE' && String(l.By || '').toLowerCase() === myEmailLc
            );

        // --- Count by DISTINCT REQUEST (not by row) ---
        const now = new Date();
        const cutoff = new Date(now.getTime() - 30*24*60*60*1000);

        // Robust request key across Pending/Ledger:
        // Pending uses PendingID; Ledger (multi-item) usually shares LinkID.
        // Fall back to RecordID or ID as a last resort.
        function reqKey(r){
          return String(
            r.PendingID ?? r.RecordID ?? r.LinkID ?? r.LinkId ?? r.ID ?? r.Id ?? ''
          ).trim() || (
            // absolute fallback (very rare): make a stable-ish composite
            `${r.Type || 'ISSUE'}|${r.When || ''}|${r.By || ''}`
          );
        }

        // Open = distinct pending requests still Pending
        const openKeys = new Set(
          mineP.filter(p => p.Status === 'Pending').map(reqKey)
        );
        const open = openKeys.size;

        // Approved (30d) = distinct approved requests in ledger within window
        const approvedKeys30 = new Set(
          mineL.filter(l => l.Status === 'Approved' && new Date(l.When) >= cutoff).map(reqKey)
        );
        const approved30 = approvedKeys30.size;

        // Declined (30d) = distinct declined requests (could be only in Pending OR in Ledger)
        const declinedKeys30 = new Set([
          // declined already finalized into ledger
          ...mineL.filter(l => l.Status === 'Declined' && new Date(l.When) >= cutoff).map(reqKey),
          // declined but still living on Pending (not finalized)
          ...mineP.filter(p => p.Status === 'Declined' && new Date(p.When) >= cutoff).map(reqKey)
        ]);
        const declined30 = declinedKeys30.size;

        // Total Requested (all time) = distinct requests across Pending + Ledger
        const totalKeys = new Set([...mineP, ...mineL].map(reqKey));
        const total = totalKeys.size;

        // Drive tiles from MY distinct-requests view
        animateNumber($('#kpiSkus'),    KPI_PREV.activeSkus, open);
        animateNumber($('#kpiOnhand'),  KPI_PREV.onhand,     approved30);
        animateNumber($('#kpiPending'), KPI_PREV.pending,    declined30);
        animateNumber($('#kpiLedger'),  KPI_PREV.ledger,     total);

        // Keep BOOT in sync with what we display
        BOOT.minePending = mineP;
        BOOT.mineLedger  = mineL;

        populateMineFilters(mineP);
        renderMine(mineP);
      } else {
        // Admin/manager mode
        idsAdmin.forEach(id => document.getElementById(id)?.classList.remove('d-none'));
        btnReq?.classList.add('d-none');
        if (stockWrap) stockWrap.classList.remove('d-none');
        if (t1) t1.textContent = 'Active SKUs';
        if (t2) t2.textContent = 'Total On-hand';
        if (t3) t3.textContent = 'Pending Approvals';
        if (t4) t4.textContent = 'Ledger Records';
        $('#myRequestsWrap').style.display = 'none';
      }
    }

    function openItemDetails(it){
      const el = $('#itemDetailsBody'); if (!el) return;
      const statusBadge =
        it.Status === 'Active'  ? '<span class="badge text-bg-success">Active</span>' :
        it.Status === 'On Hold' ? '<span class="badge text-bg-warning text-dark">On Hold</span>' :
                                  '<span class="badge text-bg-secondary">Retired</span>';

      el.innerHTML = `
        <div class="p-3 border rounded-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div class="text-secondary small">SKU</div>
              <div class="fs-5 fw-semibold">${it.SKU}</div>
              <div class="h5 mb-0">${it.Name}</div>
            </div>
            <div>${statusBadge}</div>
          </div>

          <hr class="my-3">

          <div class="row g-3">
            <div class="col-md-7">
              <dl class="row mb-0">
                <dt class="col-sm-4 text-secondary">Description</dt>
                <dd class="col-sm-8">${it.Description || '—'}</dd>

                <dt class="col-sm-4 text-secondary">Category</dt>
                <dd class="col-sm-8">${it.Category || '—'}</dd>

                <dt class="col-sm-4 text-secondary">Location</dt>
                <dd class="col-sm-8">${it.Location || '—'}</dd>
              </dl>
            </div>

            <div class="col-md-5">
              <div class="row g-2">
                <div class="col-4">
                  <div class="border rounded-3 p-2 text-center">
                    <div class="text-secondary small">On-hand</div>
                    <div class="fs-5 fw-bold">${fmt(it.Qty || 0)}</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="border rounded-3 p-2 text-center">
                    <div class="text-secondary small">UoM</div>
                    <div class="fs-5 fw-bold">${it.UoM || '—'}</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="border rounded-3 p-2 text-center">
                    <div class="text-secondary small">Unit Price</div>
                    <div class="fs-5 fw-bold">${money(computeDisplayUnitPrice(it))}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      bootstrap.Modal.getOrCreateInstance('#modalItemDetails').show();
    }

    function wireSearch(){
      $('#stockSearch')  ?.addEventListener('input', ()=>{ PAGE.stock=1;   renderItems(BOOT.items); });
      $('#pendingSearch')?.addEventListener('input', ()=>{ PAGE.pending=1; renderPending(BOOT.pending); });
      $('#ledgerSearch') ?.addEventListener('input', ()=>{ PAGE.ledger=1;  renderLedger(BOOT.ledger); });

      ['stockFilterStatus','stockFilterCat','stockFilterUom'].forEach(id=>{
        document.getElementById(id)?.addEventListener('change', ()=>{ PAGE.stock=1; renderItems(BOOT.items); });
      });
      $('#stockFilterClear')?.addEventListener('click', ()=>{
        $('#stockSearch').value='';
        ['stockFilterStatus','stockFilterCat','stockFilterUom'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        PAGE.stock=1; renderItems(BOOT.items);
      });



      ['pendFilterType','pendFilterBy','pendFilterApprover'].forEach(id=>{
        document.getElementById(id)?.addEventListener('change', ()=>{ PAGE.pending=1; renderPending(BOOT.pending); });
      });
      $('#pendFilterClear')?.addEventListener('click', ()=>{
        $('#pendingSearch').value='';
        ['pendFilterType','pendFilterBy','pendFilterApprover'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        PAGE.pending=1; renderPending(BOOT.pending);
      });

      ['ledgerFilterType','ledgerFilterStatus','ledgerFrom','ledgerTo'].forEach(id=>{
        document.getElementById(id)?.addEventListener('change', ()=>{ PAGE.ledger=1; renderLedger(BOOT.ledger); });
        document.getElementById(id)?.addEventListener('input',  ()=>{ PAGE.ledger=1; renderLedger(BOOT.ledger); });
      });
      $('#ledgerFilterClear')?.addEventListener('click', ()=>{
        $('#ledgerSearch').value='';
        ['ledgerFilterType','ledgerFilterStatus','ledgerFrom','ledgerTo'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        PAGE.ledger=1; renderLedger(BOOT.ledger);
      });

      // --- My Requests ---
      $('#mineSearch')?.addEventListener('input', ()=>{
        PAGE.mine=1; renderMine(BOOT.minePending || []);
      });
      $('#mineFilterStatus')?.addEventListener('change', ()=>{
        PAGE.mine=1; renderMine(BOOT.minePending || []);
      });
      $('#mineFilterClear')?.addEventListener('click', ()=>{
        $('#mineSearch').value='';
        const s = $('#mineFilterStatus'); if (s) s.value='';
        PAGE.mine=1; renderMine(BOOT.minePending || []);
      });
    }

    // -------- Helpers --------
    function openPriceHistory(sku){
      const it = (BOOT.items||[]).find(x => String(x.SKU)===String(sku));
      const body = document.getElementById('priceHistoryBody');
      const mEl  = document.getElementById('modalPriceHistory');
      if (!it || !body || !mEl){ return; }

      const rows = Array.isArray(it.PriceHistory) ? it.PriceHistory : [];
      if (!rows.length){
        body.innerHTML = `<div class="text-secondary">No price history for <b>${sku}</b>.</div>`;
      }else{
        const html = `
          <div class="mb-2"><b>${sku}</b> — ${it.Name || ''}</div>
          <table class="table table-sm align-middle mb-0">
            <thead><tr><th>When</th><th>By</th><th class="text-end">Price</th></tr></thead>
            <tbody>
              ${rows
                .sort((a,b)=> new Date(b.at||0) - new Date(a.at||0))
                .map(r=>`<tr><td>${when(r.at)}</td><td>${r.by||'—'}</td><td class="text-end">${money(r.price)}</td></tr>`).join('')}
            </tbody>
          </table>`;
        body.innerHTML = html;
      }
      bootstrap.Modal.getOrCreateInstance(mEl).show();
    }

    function computeDisplayUnitPrice(it){
      // Accept any of the following shapes (we’ll wire real data in backend):
      // it.UnitPrice: number
      // it.Price: number
      // it.PriceHistory: [{price:number, at?:iso, by?:string}, ...]
      if (Array.isArray(it.PriceHistory) && it.PriceHistory.length){
        const nums = it.PriceHistory.map(p => Number(p.price)).filter(v => !Number.isNaN(v));
        if (!nums.length) return null;
        const unique = Array.from(new Set(nums.map(v=>v.toFixed(2)))).map(s=>Number(s));
        if (unique.length === 1) return unique[0];
        const avg = nums.reduce((a,b)=>a+b,0) / nums.length;
        return Number(avg.toFixed(2));
      }
      const p = (it.UnitPrice ?? it.Price);
      return (p==='' || p==null) ? null : Number(p);
    }

    function lookupSku(sku){
      sku = (sku||'').trim();
      return (BOOT.items||[]).find(x => String(x.SKU) === String(sku));
    }
    function wireDownloads(){
      const bind = (id, fn) => { const el = document.getElementById(id); if (el) el.onclick = fn; };
      bind('btnDlStock',   ()=> downloadCSV('stock.csv',   LAST.stock,   COLS_STOCK));
      bind('btnDlPending', ()=> downloadCSV('pending.csv', LAST.pending, COLS_PENDING));
      bind('btnDlLedger',  ()=> downloadCSV('ledger.csv',  LAST.ledger,  COLS_LEDGER));
      bind('btnDlMine',    ()=> downloadCSV('my-requests.csv', (LAST.mine||[]).map(r=>({
        When:r.When, Status:r.Status, SKU:r.SKU, Item:r.Item, Qty:r.Qty, UoM:r.UoM, Note:r.Note||'', Reason:r.Reason||'', RecordID:r.RecordID
      })), COLS_MINE));
    }

    function wireSkuAutofill(){
      const onFill = (prefix) => {
        const sku = document.querySelector(`#${prefix}Sku`)?.value.trim() || '';
        const it  = lookupSku(sku);
        if (!it){
          ['Name','Desc','Uom','Cur'].forEach(s => { const el=document.querySelector(`#${prefix}${s}`); if(el) el.value=''; });
          return;
        }
        const map = { Name:'Name', Desc:'Description', Uom:'UoM', Cur:'Qty' };
        Object.entries(map).forEach(([suffix, key])=>{
          const el = document.querySelector(`#${prefix}${suffix}`);
          if (!el) return;
          if (suffix === 'Uom' && prefix === 'ms') {
            populateUomSelect(el, it[key] || '');
          } else {
            el.value = (key==='Qty') ? it[key] : (it[key] || '');
          }
        });
      };
      ['rc','is','ms','ri'].forEach(prefix=>{
        const el = document.querySelector(`#${prefix}Sku`);
        if (!el) return;
        el.addEventListener('input',  ()=> onFill(prefix));
        el.addEventListener('change', ()=> onFill(prefix));
      });
    }

    // --- FIND by "SKU — Name" OR direct SKU OR Name ---
    function findItemBySkuOrName(input){
      var s = String(input || '').trim();
      if (!s) return null;

      // If user picked a value like "YDC-PROC-0001 — RJ45 Cat6 Cable"
      var splitIdx = s.indexOf(' — ');
      var trySku = splitIdx > -1 ? s.slice(0, splitIdx).trim() : s;

      var items = (BOOT && BOOT.items) ? BOOT.items : [];

      // 1) Exact SKU
      var it = items.find(function(x){ return String(x.SKU) === trySku; });
      if (it) return it;

      // 2) Exact Name match
      var lc = s.toLowerCase();
      it = items.find(function(x){ return String(x.Name || '').toLowerCase() === lc; });
      if (it) return it;

      // 3) Contains Name
      it = items.find(function(x){ return String(x.Name || '').toLowerCase().indexOf(lc) > -1; });
      return it || null;
    }

    // --- Fill datalist for request search (only Active items) ---
    function fillRequestDatalist(items){
      var dl = document.getElementById('rqList');
      if (!dl) return;
      dl.innerHTML = '';
      (items || []).filter(function(it){ return String(it.Status) === 'Active'; })
        .forEach(function(it){
          var o = document.createElement('option');
          // Value a user picks → parseable: "SKU — Name"
          o.value = it.SKU + ' — ' + it.Name;
          // Label shows description as a hint
          o.label = it.Description || '';
          dl.appendChild(o);
        });
    }

    // --- Wire Request modal auto-populate ---
    function wireRequestAutofill(){
      var inp = document.getElementById('rqPick');
      if (!inp) return;

      function clearFields(){
        ['rqSku','rqName','rqDesc','rqUom','rqCur'].forEach(function(id){
          var el = document.getElementById(id); if (el) el.value = '';
        });
      }

      function refresh(){
        var it = findItemBySkuOrName(inp.value);
        clearFields();
        if (!it) return;
        document.getElementById('rqSku').value  = it.SKU;
        document.getElementById('rqName').value = it.Name || '';
        document.getElementById('rqDesc').value = it.Description || '';
        document.getElementById('rqUom').value  = it.UoM || '';
        document.getElementById('rqCur').value  = (it.Qty == null ? '' : it.Qty);
      }

      inp.addEventListener('input',  refresh);
      inp.addEventListener('change', refresh);
    }

    // --- Pending Details: de-dupe + include stamps, notes, reasons ---
    function _htmlEscape(s){
      return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function _splitBits(s){
      return String(s||'').split(/\n|\s*\|\s*/).map(x=>x.trim()).filter(Boolean);
    }
    function _uniqBits(arr){
      const seen = new Set(); const out=[];
      arr.forEach(t=>{ const k=t.toLowerCase(); if(!seen.has(k)){ seen.add(k); out.push(t); }});
      return out;
    }
    function pendingDetailsText(rec){
      // Start with server-filled Details, then enrich with Note lines (older rows)
      const base = _splitBits(rec.Details);
      const fromNote = _splitBits(rec.Note).filter(x =>
        /^(Reason:|Note:)|^\[(Submitted|Approved|Declined|Voided) by /.test(x)
      );
      return _uniqBits(base.concat(fromNote)).join(' | ');
    }
    function pendingDetailsHTML(rec){
      const txt = pendingDetailsText(rec);
      // Light formatting: stamps in muted tone
      const parts = txt.split(' | ').map(bit=>{
        if (/^\[(Submitted|Approved|Declined|Voided) by /.test(bit)){
          return `<span class="text-secondary">${_htmlEscape(bit)}</span>`;
        }
        return _htmlEscape(bit);
      });
      return parts.join(' <span class="text-muted">|</span> ');
    }

    // ===== Request flow (cart-style, multi-select up to 10) =====
    (function(){
      const MAX_REQ_ITEMS = 10;
      const RQ_CART = new Map(); // sku -> { sku, name, desc, cat, uom, onhand, qty }

      const els = {
        modalReq:      document.getElementById('modalRequest'),
        openCatalog:   document.getElementById('rqOpenCatalog'),
        cartTableBody: document.querySelector('#rqCartTable tbody'),
        cartMeta:      document.getElementById('rqCartMeta'),
        submitBtn:     document.getElementById('rqSubmitBtn'),

        // catalog
        modalCat:    document.getElementById('modalSelectItems'),
        catSearch:   document.getElementById('catSearch'),
        catCat:      document.getElementById('catFilterCat'),
        catUom:      document.getElementById('catFilterUom'),
        catClear:    document.getElementById('catClear'),
        catTbody:    document.querySelector('#tblCatalog tbody'),
        catAddBtn:   document.getElementById('catAddSelected'),
      };

      function activeOnly(items){
        // Do not show "Retired" and "On Hold"
        return (items || []).filter(it => String(it.Status) === 'Active');
      }

      function renderRqCart(){
        const rows = Array.from(RQ_CART.values());
        els.cartTableBody.innerHTML = '';

        if (!rows.length){
          els.cartMeta.textContent = 'No items selected.';
          els.submitBtn.disabled = false;
          return;
        }

        rows.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-monospace">${item.sku || ''}</td>
            <td>${item.name || ''}</td>
            <td class="small text-secondary">${item.desc || ''}</td>
            <td>${item.uom || ''}</td>
            <td class="text-end">${fmt(item.onhand || 0)}</td>
            <td class="text-end">
              <input type="number" min="1" class="form-control form-control-sm text-end rqQtyInp" style="width:120px" value="${item.qty || 1}">
            </td>
            <td class="text-end">
              <button type="button" class="btn btn-danger btn-sm rqRemove"><i class="fa-solid fa-trash-can"></i></button>
            </td>
          `;
          tr.querySelector('.rqQtyInp').addEventListener('input', (e)=>{
            const v = Number(e.target.value || 0);
            RQ_CART.set(item.sku, { ...item, qty: v > 0 ? v : 1 });
          });
          tr.querySelector('.rqRemove').addEventListener('click', ()=>{
            RQ_CART.delete(item.sku);
            renderRqCart();
          });
          els.cartTableBody.appendChild(tr);
        });

        els.cartMeta.innerHTML = `${rows.length} item(s) selected. You may still add <b>${Math.max(0, MAX_REQ_ITEMS - rows.length)}</b>.`;
        els.submitBtn.disabled = false;
      }

      // ---- Catalog (picker) ----
      function buildCatalog(){
        if (!els.catTbody) return;

        // Populate filters (first time)
        if (els.catCat && els.catCat.options.length <= 1){
          const cats = Array.from(new Set(activeOnly(BOOT.items).map(i => i.Category).filter(Boolean))).sort();
          els.catCat.innerHTML = '<option value="">All Categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        if (els.catUom && els.catUom.options.length <= 1){
          const uoms = Array.from(new Set(activeOnly(BOOT.items).map(i => i.UoM).filter(Boolean))).sort();
          els.catUom.innerHTML = '<option value="">All UoM</option>' + uoms.map(u => `<option value="${u}">${u}</option>`).join('');
        }

        const q  = (els.catSearch?.value || '').toLowerCase();
        const fC = els.catCat?.value || '';
        const fU = els.catUom?.value || '';

        const list = activeOnly(BOOT.items).filter(it=>{
          if (fC && String(it.Category || '') !== fC) return false;
          if (fU && String(it.UoM || '') !== fU) return false;
          const hay = `${it.SKU} ${it.Name} ${it.Description || ''}`.toLowerCase();
          return q ? hay.includes(q) : true;
        });

        els.catTbody.innerHTML = '';

        list.forEach(it=>{
          const already  = RQ_CART.get(it.SKU);
          const isInCart = !!already;

          const tr = document.createElement('tr');
          tr.classList.add('row-pickable');
          tr.dataset.sku = it.SKU;

          tr.innerHTML = `
            <td>
              <input type="checkbox" class="form-check-input catPick"
                    ${isInCart ? 'checked disabled' : ''} title="${isInCart ? 'Already in cart' : ''}">
            </td>
            <td class="text-monospace">${it.SKU}</td>
            <td>${it.Name}</td>
            <td class="small text-secondary">${it.Description || ''}</td>
            <td>${it.Category || ''}</td>
            <td>${it.UoM || ''}</td>
            <td class="text-end">${fmt(it.Qty || 0)}</td>
            <td class="text-end">
              <input type="number" min="1" class="form-control form-control-sm text-end catQty"
                    style="width:120px" value="${isInCart ? (already.qty || 1) : 1}" ${isInCart ? 'disabled' : ''}>
            </td>
          `;

          const cb  = tr.querySelector('.catPick');
          const qty = tr.querySelector('.catQty');

          // Helper that keeps row UI in sync with checkbox
          function mark(picked){
            // If the row is already in the cart, we lock it (checkbox is disabled)
            if (cb.disabled) {
              tr.classList.add('row-picked');
              qty.disabled = true;
              return;
            }
            cb.checked = !!picked;
            qty.disabled = !picked;
            tr.classList.toggle('row-picked', !!picked);
          }

          // Initial state
          mark(cb.checked || isInCart);

          // Single row click handler: toggle selection unless clicking directly on inputs
          tr.addEventListener('click', (e) => {
            if (e.target.closest('input')) return;  // let native input clicks work
            if (cb.disabled) return;               // skip if already in cart
            mark(!cb.checked);
          });

          // Checkbox changes → sync UI
          cb.addEventListener('change', () => mark(cb.checked));

          // Focus on qty auto-selects row (when allowed)
          qty.addEventListener('focus', () => {
            if (!cb.disabled && !cb.checked) mark(true);
          });

          // Guard qty values (>=1, integer)
          qty.addEventListener('input', (e) => {
            const v = Math.max(1, parseInt(e.target.value || '1', 10));
            if (String(v) !== e.target.value) e.target.value = v;
          });

          els.catTbody.appendChild(tr);
        });
      }


      function openCatalog(){
        buildCatalog();
        bootstrap.Modal.getOrCreateInstance(els.modalCat).show();
      }

      function addSelectedFromCatalog(){
        const rows = Array.from(els.catTbody?.querySelectorAll('tr.row-pickable') || []);
        const chosen = rows
          .filter(r => r.classList.contains('row-picked'))
          .map(r => {
            const sku   = r.children[1]?.textContent.trim();
            const name  = r.children[2]?.textContent.trim();
            const desc  = r.children[3]?.textContent.trim();
            const cat   = r.children[4]?.textContent.trim();
            const uom   = r.children[5]?.textContent.trim();
            const onhand= Number((r.children[6]?.textContent || '0').replace(/,/g,''));
            const qty   = Number(r.querySelector('.catQty')?.value || 1);
            return { sku, name, desc, cat, uom, onhand, qty: (qty>0?qty:1) };
          });

        if (!chosen.length){
          toast('Select at least one item to add.');
          return;
        }

        // Enforce 10-item limit
        const space = MAX_REQ_ITEMS - RQ_CART.size;
        if (space <= 0){
          toast({ title:'Limit reached', message:'You already have 10 items in your request.', type:'warning' });
          return;
        }
        const toAdd = chosen.slice(0, space);
        toAdd.forEach(it => { if (!RQ_CART.has(it.sku)) RQ_CART.set(it.sku, it); });

        // Feedback if some were not added due to limit
        if (chosen.length > toAdd.length){
          toast({ title:'Some not added', message:`Only ${space} more item(s) can be added.`, type:'warning' });
        }

        bootstrap.Modal.getOrCreateInstance(els.modalCat).hide();
        renderRqCart();
      }

      // ---- Wire up events ----
      els.openCatalog?.addEventListener('click', openCatalog);
      els.catSearch?.addEventListener('input', buildCatalog);
      els.catCat?.addEventListener('change', buildCatalog);
      els.catUom?.addEventListener('change', buildCatalog);
      els.catClear?.addEventListener('click', ()=>{
        if (els.catSearch) els.catSearch.value = '';
        if (els.catCat) els.catCat.value = '';
        if (els.catUom) els.catUom.value = '';
        buildCatalog();
      });
      els.catAddBtn?.addEventListener('click', addSelectedFromCatalog);

      // Reset the cart each time the Request modal opens
      els.modalReq?.addEventListener('shown.bs.modal', ()=>{
        RQ_CART.clear();
        renderRqCart();
        // focus Select Items
        setTimeout(()=> els.openCatalog?.focus(), 150);
      });

      // Submit: supports single OR multi-item requests
      document.getElementById('formRequest')?.addEventListener('submit', function(ev){
        ev.preventDefault();

        const reason = (document.getElementById('rqReason')?.value || '').trim();
        if (!reason){
          toast('Please provide a reason/purpose.', 'danger');
          return;
        }

        const itemsInCart = Array.from(RQ_CART.values());
        if (!itemsInCart.length){
          toast('Please add at least one item.', 'danger');
          return;
        }

        // Requester meta (fallbacks kept)
        const requester = {
          name:  (BOOT?.user?.name  || BOOT?.user?.email || 'Requester'),
          email: (BOOT?.user?.email || ''),
          department: (BOOT?.user?.department || '')
        };

        const btn = els.submitBtn;
        setLoading(btn, true, 'Submitting...');

        // Back-compat: if only one item, keep using the existing single-item endpoint.
        if (itemsInCart.length === 1){
          const it = itemsInCart[0];
          // single
          const payload = {
            type: 'ISSUE',                    // ← force transaction type
            items: [{ SKU: it.sku, Qty: Number(it.qty || 1) }],
            reason,
            requester // { name, email, department }
          };
          google.script.run
            .withSuccessHandler(function(){
              setLoading(btn, false);
              bootstrap.Modal.getOrCreateInstance('#modalRequest').hide();
              toast('Request submitted for approval.', 'success');
              loadApp({ silent: true });
            })
            .withFailureHandler(function(e){
              setLoading(btn, false);
              toast(e?.message || 'Failed to submit request.', 'danger');
            })
            .actionRequestItems(payload);
          return;
        }


        // Multi-item payload → matches updated Code.gs
        // If your server function is named differently (e.g. actionIssueMulti),
        // change only the function name below.
        const payload = {
          type: 'ISSUE',                    // ← force transaction type
          items: itemsInCart.map(it => ({
            SKU: it.sku,
            Qty: Number(it.qty || 1),
            UoM: it.uom || '',
            Name: it.name || ''
          })),
          reason,
          requester
        };

        google.script.run
          .withSuccessHandler(function(){
            setLoading(btn, false);
            bootstrap.Modal.getOrCreateInstance('#modalRequest').hide();
            toast('Request submitted for approval.', 'success');
            loadApp({ silent: true });
          })
          .withFailureHandler(function(e){
            setLoading(btn, false);
            toast(e?.message || 'Failed to submit request.', 'danger');
          })
          .actionRequestItems(payload); // ← update this name if your Code.gs uses a different one
      });
    })();
    
    function renderSkuHistoryTable(sku, rows){
      const head = `
        <div class="mb-2"><b>${sku}</b> — History</div>
        <div class="history-wrap">
          <table class="table table-hover align-middle sku-history-table">
            <thead>
              <tr>
                <th>When</th><th>Type</th><th class="text-end">Δ</th><th>UoM</th>
                <th>Status</th><th>By</th><th class="text-muted">ID</th>
              </tr>
            </thead>
            <tbody>`;

      const body = rows.map(r => {
        const noteHtml = (r.note || '').trim().replace(/\n/g, '<br>');
        return `
          <tr>
            <td class="when">${when(r.when)}</td>
            <td class="type">${r.type}</td>
            <td class="delta text-end">${r.delta === '' ? '' : fmt(r.delta)}</td>
            <td class="uom">${r.uom || ''}</td>
            <td class="status">${r.status || ''}</td>
            <td class="by">${r.by || ''}</td>
            <td class="id">${r.linkId || ''}</td>
          </tr>
          <tr>
            <td class="note" colspan="7">
              <div class="small text-secondary mb-1">Note / Timeline</div>
              <div style="white-space:pre-wrap">${noteHtml || '—'}</div>
            </td>
          </tr>`;
      }).join('');

      const tail = `</tbody></table></div>`;
      $('#skuHistoryBody').innerHTML = head + body + tail;
    }


    // Map to a friendly type label (client-side)
    function friendlyTypeTxt(t){
      const m = {
        CREATE_SKU: 'Create SKU',
        MODIFY_SKU: 'Modify Item',
        RETIRE_SKU: 'Retire SKU',
        RECEIVE:    'Receive (Inbound)',
        ISSUE:      'Issue (Outbound)'
      };
      return m[t] || t;
    }

    // Build a compact key/value table (used in approval confirm)
    function buildSummaryTable(rows){
      return `
        <table class="table table-sm align-middle mb-0">
          <tbody>
            ${rows.map(([k,v])=>`
              <tr>
                <th class="text-secondary" style="width:180px">${k}</th>
                <td>${v ?? '—'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
    }

    let userConfirmCtx = null; // { btn, user, role, action }

    function openUserConfirm(btn, user, role, action){ // action: 'approve'|'disable'
      userConfirmCtx = { btn, user, role, action };

      const isApprove = action === 'approve';
      const title = document.getElementById('userConfirmTitle');
      const yes   = document.getElementById('userConfirmYes');

      if (title) {
        title.innerHTML =
          `<i class="fa-solid fa-circle-question me-2"></i>${isApprove ? 'Confirm approval' : 'Confirm disable'}`;
      }
      if (yes){
        yes.className = isApprove ? 'btn btn-success' : 'btn btn-danger';
        yes.innerHTML = isApprove
          ? '<i class="fa-solid fa-check me-1"></i>Confirm Approve'
          : '<i class="fa-solid fa-user-slash me-1"></i>Confirm Disable';
      }

      const rows = [
        ['Name', user.Name || '—'],
        ['Email', user.Email || '—'],
        ['Requested Role', friendlyRole(user.RequestedRole || 'user')],
        ['Set Role', friendlyRole(role || 'user')],
        ['Action', isApprove ? 'Approve (set Active)' : 'Disable']
      ];
      const sum = document.getElementById('userConfirmSummary');
      if (sum) sum.innerHTML = buildSummaryTable(rows);

      bootstrap.Modal.getOrCreateInstance('#modalUserConfirm').show();
    }

    // Confirm click
    document.getElementById('userConfirmYes').addEventListener('click', ()=>{
      const ctx = userConfirmCtx; if (!ctx) return;

      const modalEl = document.getElementById('modalUserConfirm');
      const inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      inst.hide();

      const verb = ctx.action === 'approve' ? 'Approving...' : 'Disabling...';
      setLoading(ctx.btn, true, verb);

      const newStatus = ctx.action === 'approve' ? 'Active' : 'Disabled';
      google.script.run
        .withSuccessHandler(()=>{
          setLoading(ctx.btn, false);
          toast(ctx.action === 'approve' ? 'User approved' : 'User disabled', ctx.action === 'approve' ? 'success' : 'warning');
          loadApp({ silent:true });
          userConfirmCtx = null;
        })
        .withFailureHandler(e=>{
          setLoading(ctx.btn, false);
          toast(e.message, 'danger');
          userConfirmCtx = null;
        })
        .setUserStatus(ctx.user.UserID, ctx.role, newStatus);
    });

    let approveCtx = null; // { btn, id, rec }

    function openApproveConfirm(btn, rec){
      approveCtx = { btn, id: rec.PendingID, rec };

      const sum = document.getElementById('approveSummary');
      if (sum) sum.innerHTML = buildApproveSummaryHTML(rec);

      // reset the comment input each open
      const ac = document.getElementById('approveComment'); if (ac) ac.value = '';
      const modalEl = document.getElementById('modalApprove');
      bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }

    // Approve → server call
    document.getElementById('approveYes').addEventListener('click', ()=>{
      const ctx = approveCtx; if (!ctx || !ctx.btn) return;

      // Show spinner on the **Approve** button inside the row
      setLoading(ctx.btn, true, 'Approving...');

      // FIX: hide the modal using the element API
      const modalEl = document.getElementById('modalApprove');
      const inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      inst.hide();

      // Call server
      const approveComment = (document.getElementById('approveComment')?.value || '').trim();

      google.script.run
        .withSuccessHandler(()=>{
          setLoading(ctx.btn,false);
          toast('Approved','success');
          // clear the comment box for next time
          const ac = document.getElementById('approveComment'); if (ac) ac.value = '';
          loadApp({silent:true});
          approveCtx = null;
        })
        .withFailureHandler(e=>{
          setLoading(ctx.btn,false);
          toast(e.message,'danger');
          approveCtx = null;
        })
        // send the approver's comment along with the Approve call
        .approvePending(ctx.id, approveComment);
    });

    // Pretty label for roles used in the Users tab
    function friendlyRole(r){
      const map = {
        user: 'User (Requester)',
        manager: 'Inventory Manager',
        controller: 'Controller'
      };
      r = String(r || 'user');
      return map[r] || r;
    }

    // ---- Submits -> server pending actions ----
    $('#formCreateSku').addEventListener('submit', e=>{
      e.preventDefault();
      const payload = { sku: $('#csSku').value.trim() || '', name: $('#csName').value.trim(), desc: $('#csDesc').value.trim(), uom: $('#csUom').value.trim(), loc: $('#csLoc').value.trim(), notes: $('#csNotes').value.trim() };
      const btn = e.submitter;
      setLoading(btn, true, 'Submitting...');
      google.script.run
        .withSuccessHandler(()=>{
          setLoading(btn,false);
          toast('Submitted for approval','success');
          e.target.reset(); bootstrap.Modal.getInstance('#modalCreateSku').hide(); loadApp({silent:true});
        })
        .withFailureHandler(err=>{
          setLoading(btn,false);
          toast(err.message,'danger');
        })
        .actionCreateSku(payload);
    });

    $('#formModifySku').addEventListener('submit', e=>{
      e.preventDefault();
      const payload = {
        sku: $('#msSku').value.trim(),
        name: $('#msName').value.trim(),
        desc: $('#msDesc').value.trim(),
        uom:  $('#msUom').value.trim(),
        loc:  $('#msLoc').value.trim(),
        category: $('#msCategory').value.trim() || '',
        status: $('#msStatus').value.trim(),
        price: (()=>{ const v = $('#msPrice').value; return v==='' ? null : Number(v); })()
      };


      const btn = e.submitter;
      setLoading(btn, true, 'Submitting...');
      google.script.run
        .withSuccessHandler(()=>{
          setLoading(btn,false);
          toast('Submitted for approval','success');
          e.target.reset(); bootstrap.Modal.getInstance('#modalModifySku').hide(); loadApp({silent:true});
        })
        .withFailureHandler(err=>{
          setLoading(btn,false);
          toast(err.message,'danger');
        })
        .actionModifySku(payload);
    });

    $('#formRetireSku').addEventListener('submit', e=>{
      e.preventDefault();
      const sku = $('#rsSku').value.trim(); const notes = $('#rsNotes').value.trim();
      const btn = e.submitter;
      setLoading(btn, true, 'Submitting...');
      google.script.run
        .withSuccessHandler(()=>{
          setLoading(btn,false);
          toast('Submitted for approval','success');
          e.target.reset(); bootstrap.Modal.getInstance('#modalRetireSku').hide(); loadApp({silent:true});
        })
        .withFailureHandler(err=>{
          setLoading(btn,false);
          toast(err.message,'danger');
        })
        .actionRetireSku(sku, notes);
    });

    $('#formReceive').addEventListener('submit', e=>{
      e.preventDefault();
      const sku   = $('#rcSku').value.trim();
      const qty   = Number($('#rcQty').value);
      const notes = $('#rcNotes').value.trim();
      const it    = lookupSku(sku);
      if (!it) { toast('SKU not found','danger'); return; }
      if (!(qty > 0)) { toast('Invalid quantity','danger'); return; }

      const needsReactivation = (it.Status === 'Retired');

      if (!needsReactivation) {
        const btn = e.submitter;
        setLoading(btn, true, 'Submitting...');
        google.script.run
          .withSuccessHandler(()=>{
            setLoading(btn,false);
            toast('Submitted for approval','success');
            e.target.reset();
            bootstrap.Modal.getInstance('#modalReceive').hide();
            loadApp({silent:true});
          })
          .withFailureHandler(err=>{
            setLoading(btn,false);
            toast(err.message,'danger');
          })
          .actionReceive(sku, qty, notes, false);
        return;
      }

      // ===== Create SKUs (bulk) =====
      function csMakeRow(){
        const tpl = document.getElementById('tplCreateRow');
        const node = tpl.content.firstElementChild.cloneNode(true);
        // UoM select
        populateUomSelect(node.querySelector('.cr-uom'), '');
        // remove row
        node.querySelector('.cr-del').addEventListener('click', ()=> node.remove());
        return node;
      }
      function csCollect(){
        const rows = Array.from(document.querySelectorAll('#csRows .cr-name')).map((_,i)=> i); // index trick
        const boxes = Array.from(document.querySelectorAll('#csRows > *'));
        return boxes.map(box => {
          const name = box.querySelector('.cr-name').value.trim();
          const uom  = box.querySelector('.cr-uom').value.trim();
          const loc  = box.querySelector('.cr-loc').value.trim();
          const desc = box.querySelector('.cr-desc').value.trim();
          return { name, uom, loc, desc };
        }).filter(it => it.name); // keep filled rows
      }
      function csReset(n=1){
        const host = document.getElementById('csRows');
        host.innerHTML = '';
        for(let i=0;i<n;i++) host.appendChild(csMakeRow());
      }

      // Seed rows when the modal is fully visible (ensures DOM is ready)
      document.getElementById('modalCreateSku')?.addEventListener('shown.bs.modal', ()=> csReset(1));

      // Event delegation so the Add button always works even if listeners were early
      document.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('#csAddRow');
        if (!btn) return;
        const host = document.getElementById('csRows');
        if (!host) return;
        if (host.children.length >= 10) {
          toast({ title:'Limit reached', message:'Max 10 items per request.', type:'warning' });
          return;
        }
        host.appendChild(csMakeRow());
      });

      document.getElementById('formCreateSku')?.addEventListener('submit', function(ev){
        ev.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const items = csCollect();
        if (!items.length) { toast({message:'Add at least one item.', type:'warning'}); return; }
        // basic validation
        for(const it of items){
          if (!it.name) { toast({message:'Each row needs a name.', type:'warning'}); return; }
        }
        setLoading(btn, true, 'Submitting…');
        const note = document.getElementById('csNotes').value || '';
        google.script.run
          .withSuccessHandler(function(res){
            setLoading(btn, false);
            bootstrap.Modal.getInstance(document.getElementById('modalCreateSku'))?.hide();
            toast({ title:'Submitted', message:'Create SKUs request queued for approval.', type:'success' });
            // refresh bootstrap data
            reloadAll();
          })
          .withFailureHandler(function(e){
            setLoading(btn, false);
            toast({ title:'Error', message: (e && e.message) ? e.message : String(e), type:'danger' });
          })
          .actionCreateSkus(items, note);
      });


      const m = bootstrap.Modal.getOrCreateInstance('#modalRetiredHeadsUp');
      m.show();
      const okBtn = document.getElementById('btnRetiredHeadsUpOk');
      okBtn.onclick = () => {
        setLoading(okBtn, true, 'Submitting...');
        google.script.run
          .withSuccessHandler(()=>{
            setLoading(okBtn,false);
            bootstrap.Modal.getInstance('#modalRetiredHeadsUp')?.hide();
            bootstrap.Modal.getInstance('#modalReceive')?.hide();
            toast('Submitted for approval','success');
            e.target.reset();
            loadApp({silent:true});
          })
          .withFailureHandler(err=>{
            setLoading(okBtn,false);
            toast(err.message,'danger');
          })
          .actionReceive(sku, qty, notes, true);
      };
    });

    $('#formIssue').addEventListener('submit', e=>{
      e.preventDefault();
      const sku=$('#isSku').value.trim(), qty=Number($('#isQty').value), emp=$('#isEmp').value.trim(), dept=$('#isDept').value.trim(), reason=$('#isReason').value.trim();
      const btn = e.submitter;
      const it = lookupSku(sku);
      if (it && String(it.Status) === 'On Hold') { toast('This item is On Hold and cannot be issued.','danger'); return; }
      setLoading(btn, true, 'Submitting...');
      google.script.run
        .withSuccessHandler(()=>{
          setLoading(btn,false);
          toast('Submitted for approval','success');
          e.target.reset(); bootstrap.Modal.getInstance('#modalIssue').hide(); loadApp({silent:true});
        })
        .withFailureHandler(err=>{
          setLoading(btn,false);
          toast(err.message,'danger');
        })
        .actionIssue(sku, qty, emp, dept, reason);
    });

    // Fallbacks
    function approve(id){
      toast('Approving...','info');
      google.script.run
        .withSuccessHandler(()=>{ toast('Approved','success'); loadApp({silent:true}); })
        .withFailureHandler(e=>toast(e.message,'danger'))
        .approvePending(id);
    }
    function decline(id){
      openActionConfirm(null, id, { Type:'Transaction' }, 'decline');
    }

    (() => {
      const hup = document.getElementById('modalRetiredHeadsUp');
      if(!hup) return;
      hup.addEventListener('show.bs.modal', () => {
        setTimeout(() => {
          const backs = document.querySelectorAll('.modal-backdrop');
          const last = backs[backs.length - 1];
          if(last) last.classList.add('hup-top');
        }, 0);
      });
      hup.addEventListener('hidden.bs.modal', () => {
        document.querySelectorAll('.modal-backdrop.hup-top')
          .forEach(b => b.classList.remove('hup-top'));
      });
    })();

     let LIVE_VER = null;

    // Call once after your initial render(getBootstrap)
    function startLiveUpdates(){
      function schedule(){ setTimeout(tick, document.hidden ? 8000 : 2500); } // back off when tab hidden
      function tick(){
        google.script.run.withSuccessHandler(function(v){
          if (LIVE_VER === null) { LIVE_VER = v; return schedule(); }
          if (v !== LIVE_VER) {
            LIVE_VER = v;
            // re-fetch fresh data and re-render your UI
            google.script.run.withSuccessHandler(function(b){
              // reuse your existing render path:
              // e.g., renderCounts(b.counts); renderTables(b.items, b.pending, b.ledger);
              // or a single renderAll(b);
            }).getBootstrap();
          }
          schedule();
        }).getDbVersionLight();
      }
      tick();
    }

    /* ===== Soft auto-reload (every 15s, no loader, no scroll jump) ===== */
    (function(){
      const REFRESH_MS = 15000;
      let busy = false;

      function shouldDefer(){
        if (document.hidden) return true;
        if (document.querySelector('.modal.show')) return true;
        const ae = document.activeElement;
        if (ae && ['INPUT','TEXTAREA','SELECT'].includes(ae.tagName) && !ae.readOnly && !ae.disabled) return true;
        return false;
      }

      // Subtle “updated” blip on the DB chip
      function flashUpdated(){
        const chip = document.getElementById('dbChip');
        if (!chip) return;
        chip.classList.remove('bg-secondary-subtle');
        chip.classList.add('bg-success-subtle');
        setTimeout(()=>{ chip.classList.add('bg-secondary-subtle'); chip.classList.remove('bg-success-subtle'); }, 500);
      }

      function softReload(){
        if (busy) return;
        if (shouldDefer()) return;

        busy = true;
        const pos = { x: window.scrollX, y: window.scrollY };
        const activeId = document.activeElement && document.activeElement.id;

        // Pull fresh snapshot, re-render just the views (no loader, no filter resets)
        google.script.run
          .withSuccessHandler(payload => {
            BOOT = payload;  // keep your global in sync
            if ((payload.user?.role || '').toLowerCase() === 'user') {
             renderUserKpis(payload);               // keep SLA/KPI tiles filtered for the user
             renderMine(payload.minePending || []); // keep "My Requests" fresh too
             populateMineFilters(payload.minePending || []);
           } else {
             renderCounts(payload.counts);          // admins/managers still see global counts
           }
            renderItems(payload.items);
            renderPending(payload.pending);
            renderUsersPending(payload.usersPending || []);
            renderLedger(payload.ledger);
            fillRetireDatalist(payload.items); // keep retire datalist accurate

            // Restore scroll & focus
            requestAnimationFrame(() => {
              window.scrollTo(pos.x, pos.y);
              if (activeId) {
                const el = document.getElementById(activeId);
                if (el && typeof el.focus === 'function') { try { el.focus({ preventScroll: true }); } catch(_){} }
              }
            });

            flashUpdated();
            busy = false;
          })
          .withFailureHandler(() => { busy = false; })
          .getBootstrap();
      }

      // Public starter: call after first paint
      window.startSoftReload = function(){
        setInterval(softReload, REFRESH_MS);
      };
    })();

    // Kick off — show loader only on first boot
    window.addEventListener('DOMContentLoaded', () => { 
      loadApp();              // shows loader only on first boot
      startSoftReload();      // silent refresh every 15s
    });

    // ===== Multi-Item Receive/Issue UI =====
    (function(){
      const MAX_ROWS = 10;

      function findItem(sku){
        if (!BOOT || !BOOT.items) return null;
        return BOOT.items.find(x => String(x.SKU) === String(sku)) || null;
      }

      function skuInput(listId){
        return `<input class="form-control sku" list="${listId}" placeholder="SKU" autocomplete="off" required>`;
      }
      function readonlyInput(cls, ph){ return `<input class="form-control ${cls}" placeholder="${ph||'—'}" disabled>`; }
      function qtyInput(min){ return `<input type="number" class="form-control qty" min="${min||1}" value="1" required>`; }

      function rowTpl(kind){
        // kind: 'rc' or 'is'
        return `
          <div class="p-2 border rounded-3 rcis-row">
            <div class="row g-2 align-items-end">
              <div class="col-sm-4">
                <label class="form-label">SKU</label>
                ${skuInput('skuList')}
              </div>
              <div class="col-sm-4">
                <label class="form-label">Item</label>
                ${readonlyInput('name','Item name')}
              </div>
              <div class="col-sm-2">
                <label class="form-label">UoM</label>
                ${readonlyInput('uom','—')}
              </div>
              <div class="col-sm-2">
                <label class="form-label">On-hand</label>
                ${readonlyInput('cur','0')}
              </div>
              <div class="col-sm-3">
                <label class="form-label">${kind==='rc'?'Qty to Receive':'Qty to Pull-out'}</label>
                ${qtyInput(1)}
              </div>
              <div class="col-sm-2 d-flex gap-2">
                <button type="button" class="btn btn-light-alt w-100 btn-remove">Remove</button>
              </div>
            </div>
          </div>`;
      }

      function wireRow(container, rowEl, kind){
        const skuEl = rowEl.querySelector('.sku');
        const nameEl= rowEl.querySelector('.name');
        const uomEl = rowEl.querySelector('.uom');
        const curEl = rowEl.querySelector('.cur');
        const qtyEl = rowEl.querySelector('.qty');
        const rmBtn = rowEl.querySelector('.btn-remove');

        rmBtn.addEventListener('click', ()=> {
          rowEl.remove();
        });

        skuEl.addEventListener('change', ()=>{
          const sku = skuEl.value.trim();
          if (!sku) return;

          // no duplicates
          const all = Array.from(container.querySelectorAll('.sku')).map(i => i.value.trim()).filter(Boolean);
          const dups = all.filter((s,idx,arr)=> arr.indexOf(s) !== idx);
          if (dups.includes(sku)) {
            toast({ title:'Duplicate SKU', message:`${sku} already added.`, type:'warning' });
            skuEl.value = '';
            nameEl.value = uomEl.value = curEl.value = '';
            return;
          }

          const it = findItem(sku);
          if (!it) {
            toast({ title:'Not found', message:`SKU ${sku} does not exist.`, type:'danger' });
            skuEl.value = '';
            return;
          }
          if (String(it.Status) !== 'Active') {
            toast({ title:'Inactive', message:`${sku} is not Active.`, type:'warning' });
            skuEl.value = '';
            return;
          }

          nameEl.value = it.Name || '';
          uomEl.value  = it.UoM || '';
          curEl.value  = Number(it.Qty||0);

          if (kind === 'is') {
            // cannot exceed onhand
            qtyEl.setAttribute('max', String(Number(it.Qty||0)));
          }
        });
      }

      // ---- Receive modal
      (function(){
        const rowsHost = document.getElementById('rcRows');
        const addBtn   = document.getElementById('rcAddRow');
        const form     = document.getElementById('formReceive');
        if (!rowsHost || !addBtn || !form) return;

        function addRow(){
          if (rowsHost.querySelectorAll('.rcis-row').length >= MAX_ROWS) {
            toast({ title:'Limit reached', message:`Maximum of ${MAX_ROWS} items.`, type:'warning' });
            return;
          }
          const div = document.createElement('div');
          div.innerHTML = rowTpl('rc');
          const el = div.firstElementChild;
          rowsHost.appendChild(el);
          wireRow(rowsHost, el, 'rc');
        }

        addBtn.addEventListener('click', addRow);
        // start with one row each open
        $('#modalReceive').addEventListener('shown.bs.modal', ()=>{
          rowsHost.innerHTML = '';
          addRow();
        });

        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const btn = e.submitter;
          const note = document.getElementById('rcNotes').value.trim();

          const rows = Array.from(rowsHost.querySelectorAll('.rcis-row'));
          if (!rows.length) { toast('Add at least one item','warning'); return; }

          const items = [];
          for (const r of rows) {
            const sku = r.querySelector('.sku')?.value.trim();
            const qty = Number(r.querySelector('.qty')?.value);
            const cur = Number(r.querySelector('.cur')?.value);
            const name= r.querySelector('.name')?.value;
            const uom = r.querySelector('.uom')?.value;

            if (!sku || !(qty>0)) { toast('Check item rows','warning'); return; }
            const it = findItem(sku);
            if (!it || String(it.Status)!=='Active') { toast(`SKU ${sku} must be Active`,'danger'); return; }

            items.push({ sku, qty }); // server will expand to Name/UoM
          }

          setLoading(btn, true, 'Submitting…');
          google.script.run
            .withSuccessHandler(() => {
              setLoading(btn, false);
              toast({ title:'Submitted', message:'Receive queued for approval.', type:'success' });
              form.reset();
              bootstrap.Modal.getInstance('#modalReceive').hide();
              loadApp({silent:true});
            })
            .withFailureHandler(err=>{
              setLoading(btn, false);
              toast({ title:'Error', message: (err && err.message) || String(err), type:'danger' });
            })
            .actionReceiveMulti(items, note);
        });
      })();

      // ---- Issue modal
      (function(){
        const rowsHost = document.getElementById('isRows');
        const addBtn   = document.getElementById('isAddRow');
        const form     = document.getElementById('formIssue');
        if (!rowsHost || !addBtn || !form) return;

        function addRow(){
          if (rowsHost.querySelectorAll('.rcis-row').length >= MAX_ROWS) {
            toast({ title:'Limit reached', message:`Maximum of ${MAX_ROWS} items.`, type:'warning' });
            return;
          }
          const div = document.createElement('div');
          div.innerHTML = rowTpl('is');
          const el = div.firstElementChild;
          rowsHost.appendChild(el);
          wireRow(rowsHost, el, 'is');
        }

        addBtn.addEventListener('click', addRow);
        $('#modalIssue').addEventListener('shown.bs.modal', ()=>{
          rowsHost.innerHTML = '';
          addRow();
        });

        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const btn  = e.submitter;

          const emp  = document.getElementById('isEmp').value.trim();
          const bu   = document.getElementById('isBU').value.trim();
          const dept = document.getElementById('isDept').value.trim();        // NOW a <select>
          const loc  = document.getElementById('isDeployLoc').value.trim();   // NEW
          const rsn  = document.getElementById('isReason').value.trim();

          // Required field checks
          if (!emp || !bu || !dept || !loc || !rsn) {
            toast('Please complete Employee, Business Unit, Department, Deployment Location, and Reason.','warning');
            return;
          }

          const rows = Array.from(rowsHost.querySelectorAll('.rcis-row'));
          if (!rows.length) { toast('Add at least one item','warning'); return; }

          const items = [];
          const seen = new Set();
          for (const r of rows) {
            const sku = r.querySelector('.sku')?.value.trim();
            const qty = Number(r.querySelector('.qty')?.value);
            if (!sku || !(qty>0)) { toast('Check item rows','warning'); return; }
            if (seen.has(sku)) { toast(`Duplicate SKU ${sku}`,'danger'); return; } else seen.add(sku);

            const it = findItem(sku);
            if (!it || String(it.Status)!=='Active') { toast(`SKU ${sku} must be Active`,'danger'); return; }
            if (qty > Number(it.Qty||0)) { toast(`Cannot issue more than on-hand for ${sku}`,'danger'); return; }

            items.push({ sku, qty });
          }

          setLoading(btn, true, 'Submitting…');
          google.script.run
            .withSuccessHandler(() => {
              setLoading(btn, false);
              toast({ title:'Submitted', message:'Issue queued for approval.', type:'success' });
              form.reset();
              bootstrap.Modal.getInstance('#modalIssue').hide();
              loadApp({silent:true});
            })
            .withFailureHandler(err=>{
              setLoading(btn, false);
              toast({ title:'Error', message: (err && err.message) || String(err), type:'danger' });
            })
            // NEW params: businessUnit + deploymentLocation
            .actionIssueMulti(items, emp, dept, rsn, bu, loc);
        });

      })();
    })();
  </script>
</body>
</html>